# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Docora is a headless service that monitors GitHub repositories, detects structural file changes, applies optional transformation plugins, and notifies registered client applications via push-based API. It treats repositories as collections of files/directories using hash-based change detection without semantic validation.

## Development Commands

```bash
pnpm dev          # Start dev server with hot reload (tsx watch)
pnpm build        # Compile TypeScript to dist/
pnpm start        # Run compiled production build
pnpm test         # Run tests once
pnpm test:watch   # Run tests in watch mode
pnpm typecheck    # Type check without emitting
pnpm worker       # Start worker with hot reload
pnpm worker:start # Run compiled worker
```

## Architecture

**Entry Points:**
- `src/index.ts` - Application entry point, loads dotenv, starts server and/or worker based on `RUN_MODE`
- `src/worker.ts` - Worker entry point for background job processing
- `src/server.ts` - Fastify server builder with CORS/Helmet/Swagger middleware

**Routes:**
- `src/routes/index.ts` - Route aggregator that registers all route modules
- `src/routes/health.ts` - GET `/health` endpoint (timestamp, uptime)
- `src/routes/version.ts` - GET `/version` endpoint (version info, build details)
- `src/routes/admin/onboard.ts` - POST `/admin/api/apps/onboard` (admin-only app registration)
- `src/routes/repositories/register.ts` - POST `/api/repositories` (repo registration)

**Database Layer:**
- `src/db/index.ts` - Kysely connection pool, getDatabase(), closeDatabase()
- `src/db/types/` - TypeScript interfaces for database tables

**Repositories (Data Access):**
- `src/repositories/apps.ts` - App CRUD operations
- `src/repositories/repositories.ts` - Repository CRUD operations
- `src/repositories/snapshots.ts` - Snapshot storage and retrieval
- `src/repositories/deliveries.ts` - Per-app file delivery tracking

**Services:**
- `src/services/git.ts` - Clone/pull repositories, get commit SHA
- `src/services/scanner.ts` - Walk filesystem, compute file hashes, detect binary files
- `src/services/notifier.ts` - Send granular file notifications (create/update/delete) with HMAC authentication
- `src/services/chunked-notifier.ts` - Handle chunked delivery for large binary files
- `src/services/change-detector.ts` - Detect file changes by comparing current scan with previous snapshot
- `src/services/repository-management.ts` - Orchestrates repository unwatch logic (used by both unwatch and re-registration)

**Workers (BullMQ):**
- `src/workers/snapshot.scheduler.ts` - Schedules pending snapshot jobs
- `src/workers/snapshot.worker.ts` - Processes snapshot jobs

**Plugins:**
- `src/plugins/auth.ts` - Bearer token authentication middleware
- `src/plugins/swagger.ts` - OpenAPI/Swagger configuration
- `src/plugins/pipeline.ts` - Plugin pipeline interface (hook for transformations)

**Utilities:**
- `src/utils/token.ts` - Generate app IDs and tokens
- `src/utils/crypto.ts` - AES-256 encryption for GitHub tokens
- `src/utils/github.ts` - Parse GitHub URLs, validate repos via API
- `src/utils/url-validator.ts` - SSRF protection
- `src/utils/docoraignore.ts` - Parse .docoraignore patterns
- `src/utils/signature.ts` - HMAC signature generation for webhook authentication
- `src/utils/binary.ts` - Binary file detection using isbinaryfile
- `src/utils/chunking.ts` - Split large files into chunks for transmission

**Queue:**
- `src/queue/connection.ts` - Redis/ioredis connection for BullMQ

**Version Management:**
- `src/version.ts` - Version constants and build info. Generated by extract-version script from STATE.md.

**Documentation Site:**
- `docs-site/` - Hugo-based public documentation site (webhook API docs)
- `docs-site/content/_index.md` - Main documentation content
- `docs-site/Dockerfile` - Multi-stage build (Hugo â†’ nginx)

## Docker Configuration

The production Docker image (`Dockerfile`) includes:
- `node:22-alpine` as base image
- `git` installed for repository cloning
- `/data/repos` directory with `node:node` ownership for repository storage
- Runs as non-root `node` user for security

The `docker-compose.yml` includes:
- `repos_data` volume mounted to `/data/repos` on the worker
- Worker depends on Redis and Liquibase migrations

**Important:** `REPOS_BASE_PATH` must be an absolute path (`/data/repos`), not relative.

## Conventions

**ES Modules with TypeScript:** Imports require `.js` extension even for `.ts` source files (e.g., `import { foo } from "./bar.js"`). TypeScript compiles to ESM output.

**Commit Style:** Conventional commit format preferred (feat:, fix:, docs:, chore:, etc.) but not enforced by tooling.

## Rules

- **our names** Refer to me as "Toto", I call you "Claude"
- **Git: commit yes, push no** Claude can stage and commit changes, but never push. Toto controls when to update production.
- **sql migration as yml liquibase** Database migrations must be provided as a yml file (not sql or xml...)
- **documentation in sync** take the documentation always updated
- **language** : we can speak in Italian ora English as well, but all the project files (doc and code must be written in English)
- **planning** : when I propose a new feature, there are two important steps to take before implementing it: thinking about possible alternatives, a technological proposal, and creating a plan. For these two steps, use ultrathink and ask me all the necessary questions.
- **code file size** : code files should be no longer than 150 lines. Try to split them if necessary. If this isn't possible, you can ignore this rule.
- **code quality** : code must follow solid principles like.
    -short functions with a single responsibility (Single Responsibility Principle)
    -DRY
    -KISS
    -Separation of Concerns
    -Dependency Injection:
    -Fail fast