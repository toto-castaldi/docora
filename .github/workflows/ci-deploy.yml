name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # ─────────────────────────────────────────────
    # Build & Test
    # ─────────────────────────────────────────────
    build-test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            -   name: Setup pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 9.15.0

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache: 'pnpm'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile

            -   name: Type check
                run: pnpm typecheck

            -   name: Run tests
                run: pnpm test

    # ─────────────────────────────────────────────
    # Build & Push Docker Image
    # ─────────────────────────────────────────────
    docker:
        needs: build-test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        outputs:
            version: ${{ steps.version.outputs.docker_tag }}
        steps:
            - uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: 22

            -   name: Extract version from STATE.md
                id: version
                run: |
                    VERSION=$(BUILD_NUMBER=${{ github.run_number }} COMMIT_SHA=${{ github.sha }} node scripts/extract-version.cjs)
                    DOCKER_TAG=$(echo "$VERSION" | tr '+' '-')
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                    echo "docker_tag=$DOCKER_TAG" >> $GITHUB_OUTPUT
                    echo "Extracted version: $VERSION (Docker tag: $DOCKER_TAG)"

            -   name: Log in to Container Registry
                uses: docker/login-action@v3
                with:
                    registry: ${{ env.REGISTRY }}
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Build and push API image
                uses: docker/build-push-action@v6
                with:
                    context: .
                    push: true
                    tags: |
                        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.docker_tag }}
                        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                    build-args: |
                        BUILD_NUMBER=${{ github.run_number }}
                        COMMIT_SHA=${{ github.sha }}
                        BUILD_DATE=${{ github.event.head_commit.timestamp }}

            -   name: Build and push docs image
                uses: docker/build-push-action@v6
                with:
                    context: ./docs-site
                    push: true
                    tags: |
                        ${{ env.REGISTRY }}/${{ github.repository }}-docs:${{ steps.version.outputs.docker_tag }}
                        ${{ env.REGISTRY }}/${{ github.repository }}-docs:latest

    # ─────────────────────────────────────────────
    # Deploy to Production
    # ─────────────────────────────────────────────
    deploy:
        needs: docker
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            -   name: Copy files to server
                uses: appleboy/scp-action@v0.1.7
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    source: "deploy/docker-compose.yml,deploy/caddy/Caddyfile,deploy/liquibase"
                    target: "/opt/docora"
                    strip_components: 1

            -   name: Deploy via SSH
                uses: appleboy/ssh-action@v1
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    script: |
                        cd /opt/docora
                        docker compose -f docker-compose.yml pull
                        docker compose -f docker-compose.yml up -d --remove-orphans
                        docker compose -f docker-compose.yml restart caddy
                        docker image prune -f
