name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # ─────────────────────────────────────────────
    # Build & Test
    # ─────────────────────────────────────────────
    build-test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            -   name: Setup pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 9.15.0

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache: 'pnpm'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile

            -   name: Type check
                run: pnpm typecheck

            -   name: Run tests
                run: pnpm test

    # ─────────────────────────────────────────────
    # Auto-Release (only on main)
    # ─────────────────────────────────────────────
    release:
        needs: build-test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-latest
        permissions:
            contents: write
        outputs:
            released: ${{ steps.bump.outputs.released }}
            version: ${{ steps.bump.outputs.version }}
            tag: ${{ steps.bump.outputs.tag }}
        steps:
            -   uses: actions/checkout@v4
                with:
                    fetch-depth: 0
                    token: ${{ secrets.GITHUB_TOKEN }}

            -   name: Setup Git
                run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"

            -   name: Analyze commits and bump version
                id: bump
                run: |
                    # Get latest tag
                    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                    echo "Latest tag: $LATEST_TAG"

                    # Get commits since last tag
                    COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")
                    echo "Commits since $LATEST_TAG:"
                    echo "$COMMITS"

                    # Check for version bump triggers
                    HAS_FEAT=$(echo "$COMMITS" | grep -c "^feat" || true)
                    HAS_FIX=$(echo "$COMMITS" | grep -c "^fix" || true)
                    HAS_BREAKING=$(echo "$COMMITS" | grep -c "^feat!\\|^fix!" || true)

                    # Skip if only chore/docs/etc commits
                    if [ "$HAS_FEAT" -eq 0 ] && [ "$HAS_FIX" -eq 0 ]; then
                    echo "No feat/fix commits, skipping release"
                    echo "released=false" >> $GITHUB_OUTPUT
                    exit 0
                    fi

                    # Parse current version
                    CURRENT=${LATEST_TAG#v}
                    IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

                    # Calculate new version
                    if [ "$HAS_BREAKING" -gt 0 ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                    elif [ "$HAS_FEAT" -gt 0 ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                    else
                    PATCH=$((PATCH + 1))
                    fi

                    NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
                    NEW_TAG="v${NEW_VERSION}"
                    echo "New version: $NEW_VERSION"

                    # Update version files
                    sed -i "s/VERSION = \".*\"/VERSION = \"$NEW_VERSION\"/" src/version.ts
                    sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" package.json

                    # Commit and tag
                    git add src/version.ts package.json
                    git commit -m "chore(release): ${NEW_TAG}"
                    git tag -a "$NEW_TAG" -m "Release ${NEW_TAG}"
                    git push origin main --follow-tags


                    # Output for next jobs
                    echo "released=true" >> $GITHUB_OUTPUT
                    echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                    echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

    # ─────────────────────────────────────────────
    # Build & Push Docker Image
    # ─────────────────────────────────────────────
    docker:
        needs: release
        if: needs.release.outputs.released == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            packages: write
        steps:
            -   uses: actions/checkout@v4

            -   name: Log in to Container Registry
                uses: docker/login-action@v3
                with:
                    registry: ${{ env.REGISTRY }}
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Extract metadata
                id: meta
                uses: docker/metadata-action@v5
                with:
                    images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                    tags: |
                        type=semver,pattern={{version}},value=${{ needs.release.outputs.version }}
                        type=raw,value=latest

            -   name: Build and push
                uses: docker/build-push-action@v6
                with:
                    context: .
                    push: true
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}
                    build-args: |
                        BUILD_NUMBER=${{ github.run_number }}
                        COMMIT_SHA=${{ github.sha }}
                        BUILD_DATE=${{ github.event.head_commit.timestamp }}

    # ─────────────────────────────────────────────
    # Deploy to DigitalOcean
    # ─────────────────────────────────────────────
    deploy:
        needs: [release, docker]
        if: needs.release.outputs.released == 'true'
        runs-on: ubuntu-latest
        steps:
            -   name: Copy files to server
                uses: appleboy/scp-action@v0.1.7
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    source: "deploy/docker-compose.yml,deploy/caddy/Caddyfile"
                    target: "/opt/docora"
                    strip_components: 1

            -   name: Deploy via SSH
                uses: appleboy/ssh-action@v1
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.DEPLOY_SSH_KEY }}
                    script: |
                        cd /opt/docora
                        docker compose -f docker-compose.yml pull
                        docker compose -f docker-compose.yml up -d --remove-orphans
                        docker image prune -f