---
phase: 13-app-deletion-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared-types/src/dashboard.ts
  - src/repositories/admin-dashboard.ts
  - src/routes/admin/dashboard-api-apps.ts
  - dashboard/src/api/admin.ts
  - dashboard/src/components/ConfirmDialog.tsx
  - dashboard/src/components/ConfirmDialog.module.css
autonomous: true
requirements: [DEL-03]

must_haves:
  truths:
    - "AppDetail API response includes snapshot_count and delivery_count"
    - "Frontend can call DELETE /admin/api/apps/:appId via deleteApi helper"
    - "ConfirmDialog supports loading prop that disables buttons and shows spinner"
    - "ConfirmDialog message prop accepts ReactNode for bold text formatting"
  artifacts:
    - path: "packages/shared-types/src/dashboard.ts"
      provides: "AppDetail with snapshot_count and delivery_count, DeleteAppResult type"
      contains: "snapshot_count"
    - path: "src/routes/admin/dashboard-api-apps.ts"
      provides: "Enriched app detail response with snapshot/delivery counts"
      contains: "snapshot_count"
    - path: "dashboard/src/api/admin.ts"
      provides: "deleteApi helper and deleteApp function"
      contains: "deleteApp"
    - path: "dashboard/src/components/ConfirmDialog.tsx"
      provides: "Loading state with disabled buttons and spinner"
      contains: "loading"
  key_links:
    - from: "dashboard/src/api/admin.ts"
      to: "DELETE /admin/api/apps/:appId"
      via: "deleteApi fetch with DELETE method"
      pattern: "deleteApi.*DELETE"
    - from: "src/routes/admin/dashboard-api-apps.ts"
      to: "repository_snapshots, app_delivered_files tables"
      via: "COUNT queries for snapshot and delivery counts"
      pattern: "snapshot_count|delivery_count"
---

<objective>
Add backend count enrichment, frontend API delete helper, and ConfirmDialog loading state to support app deletion UI.

Purpose: Provide all the infrastructure building blocks that Plan 02 needs to wire delete buttons and confirmation dialogs on the Apps list and AppDetail pages.
Output: Enriched AppDetail response with counts, deleteApi/deleteApp functions in admin.ts, enhanced ConfirmDialog with loading support, DeleteAppResult type in shared-types.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-app-deletion-backend/12-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From packages/shared-types/src/dashboard.ts:
```typescript
export interface AppSummary {
  app_id: string;
  app_name: string;
  base_url: string;
  created_at: string;
  repository_count: number;
  failed_notification_count: number;
}

export interface AppDetail extends AppSummary {
  email: string;
  website: string | null;
  description: string | null;
  repositories: RepositorySummary[];
}

export interface ApiResponse<T> { data: T; }
export interface ApiErrorResponse { error: string; }
```

From src/services/app-deletion.ts:
```typescript
export interface DeleteAppResult {
  deleted: boolean;
  repositories_unlinked: number;
  orphaned_repositories_cleaned: number;
}
```

From dashboard/src/api/admin.ts:
```typescript
class ApiError extends Error {
  constructor(message: string, public status: number) { ... }
}

async function fetchApi<T>(endpoint: string): Promise<T> { ... }
async function postApi<T>(endpoint: string, body: unknown): Promise<T> { ... }
// No deleteApi exists yet
```

From dashboard/src/components/ConfirmDialog.tsx:
```typescript
interface ConfirmDialogProps {
  open: boolean;
  title: string;
  message: string;           // Currently string-only -- needs ReactNode
  confirmLabel?: string;
  cancelLabel?: string;
  onConfirm: () => void;
  onCancel: () => void;
  variant?: "danger" | "warning";
  // No loading prop yet
}
```

From src/routes/admin/dashboard-api-apps.ts:
```typescript
// GET /admin/api/apps/:appId handler builds AppDetail response
// Currently does NOT include snapshot_count or delivery_count
```

From src/repositories/admin-dashboard.ts:
```typescript
export async function getAppById(appId: string): Promise<AppDetailResult | null>
export async function listRepositoriesByApp(appId: string): Promise<RepositoryWithStatus[]>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich AppDetail type and backend response with snapshot and delivery counts</name>
  <files>
    packages/shared-types/src/dashboard.ts
    packages/shared-types/src/index.ts
    src/repositories/admin-dashboard.ts
    src/routes/admin/dashboard-api-apps.ts
  </files>
  <action>
1. In `packages/shared-types/src/dashboard.ts`:
   - Add `snapshot_count: number` and `delivery_count: number` to the `AppDetail` interface (after `failed_notification_count`, before `repositories`).
   - Add a new exported interface `DeleteAppResult` with fields matching the backend type:
     ```typescript
     export interface DeleteAppResult {
       deleted: boolean;
       repositories_unlinked: number;
       orphaned_repositories_cleaned: number;
     }
     ```
   - Export `DeleteAppResult` from `packages/shared-types/src/index.ts`.

2. In `src/repositories/admin-dashboard.ts`:
   - Add two new exported functions:
     ```typescript
     export async function countSnapshotsByApp(appId: string): Promise<number>
     ```
     Queries: `SELECT COUNT(repository_snapshots.id) FROM repository_snapshots INNER JOIN app_repositories ON app_repositories.repository_id = repository_snapshots.repository_id WHERE app_repositories.app_id = appId`.
     Returns `Number(result?.count) || 0`.

     ```typescript
     export async function countDeliveriesByApp(appId: string): Promise<number>
     ```
     Queries: `SELECT COUNT(app_id) FROM app_delivered_files WHERE app_id = appId`.
     Returns `Number(result?.count) || 0`.

3. In `src/routes/admin/dashboard-api-apps.ts`:
   - Import `countSnapshotsByApp` and `countDeliveriesByApp` from the admin-dashboard repository.
   - In the `GET /admin/api/apps/:appId` handler, after fetching `app` and `repos`, add:
     ```typescript
     const [snapshotCount, deliveryCount] = await Promise.all([
       countSnapshotsByApp(appId),
       countDeliveriesByApp(appId),
     ]);
     ```
   - Add `snapshot_count: snapshotCount` and `delivery_count: deliveryCount` to the response object.
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>AppDetail type includes snapshot_count and delivery_count. Backend GET /admin/api/apps/:appId returns these counts. DeleteAppResult is exported from shared-types.</done>
</task>

<task type="auto">
  <name>Task 2: Add deleteApi helper and deleteApp function to frontend API layer</name>
  <files>dashboard/src/api/admin.ts</files>
  <action>
In `dashboard/src/api/admin.ts`:

1. Add the `DeleteAppResult` import from `@docora/shared-types` (add it to the existing type import block at the top).

2. Add a new `deleteApi` private function following the exact same pattern as `fetchApi` and `postApi`:
   ```typescript
   async function deleteApi<T>(endpoint: string): Promise<T> {
     const response = await fetch(`/admin${endpoint}`, {
       method: "DELETE",
       credentials: "include",
     });

     if (!response.ok) {
       const errorData = (await response.json().catch(() => ({
         error: "Unknown error",
       }))) as ApiErrorResponse;
       throw new ApiError(errorData.error, response.status);
     }

     const data = (await response.json()) as ApiResponse<T>;
     return data.data;
   }
   ```

3. Add an exported `deleteApp` function:
   ```typescript
   export async function deleteApp(appId: string): Promise<DeleteAppResult> {
     return deleteApi<DeleteAppResult>(`/api/apps/${appId}`);
   }
   ```

Place `deleteApi` right after the `postApi` function definition. Place `deleteApp` with the other exported functions (after `resyncByApp` is fine).
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>deleteApi helper and deleteApp function exist in admin.ts. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance ConfirmDialog with loading state and ReactNode message</name>
  <files>
    dashboard/src/components/ConfirmDialog.tsx
    dashboard/src/components/ConfirmDialog.module.css
  </files>
  <action>
1. In `dashboard/src/components/ConfirmDialog.tsx`:
   - Add `Loader2` to the lucide-react import: `import { Loader2 } from "lucide-react";`
   - Change the `message` prop type from `string` to `React.ReactNode` (backward-compatible -- strings are valid ReactNode).
   - Add an optional `loading?: boolean` prop to `ConfirmDialogProps`.
   - Destructure `loading = false` in the component function parameters.
   - On the cancel button: add `disabled={loading}`.
   - On the confirm button: add `disabled={loading}`.
   - Inside the confirm button, before the label text, conditionally render the spinner:
     ```tsx
     {loading && <Loader2 size={14} className={styles.spin} />}
     {confirmLabel}
     ```
   - Change the message element from `<p>` to `<div>` to properly support ReactNode children (block-level elements inside `<p>` would be invalid HTML):
     ```tsx
     <div className={styles.message}>{message}</div>
     ```

2. In `dashboard/src/components/ConfirmDialog.module.css`:
   - Add a `.spin` class with the spinner animation:
     ```css
     .spin {
       animation: spin 1s linear infinite;
     }

     @keyframes spin {
       from { transform: rotate(0deg); }
       to { transform: rotate(360deg); }
     }
     ```
   - Add disabled styles for both buttons:
     ```css
     .cancelButton:disabled {
       opacity: 0.5;
       cursor: not-allowed;
     }

     .confirmButton:disabled {
       opacity: 0.5;
       cursor: not-allowed;
     }
     ```
   - Add inline-flex + gap to confirmButton so the spinner and text align nicely:
     Add `display: inline-flex;`, `align-items: center;`, and `gap: 0.375rem;` to `.confirmButton`.
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>ConfirmDialog accepts optional loading prop. When loading=true, both buttons are disabled and the confirm button shows a spinner. Message prop accepts ReactNode. Existing ConfirmDialog usages remain unaffected (loading defaults to false, string is valid ReactNode).</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes for the entire monorepo (backend + shared-types + dashboard).
2. Existing ConfirmDialog usages in AppDetail.tsx still compile without changes (backward-compatible).
3. No new runtime errors -- all changes are additive.
</verification>

<success_criteria>
- AppDetail shared type includes snapshot_count, delivery_count fields
- DeleteAppResult type exported from shared-types
- Backend GET /admin/api/apps/:appId response includes snapshot_count and delivery_count from DB queries
- admin.ts has deleteApi helper and exported deleteApp function
- ConfirmDialog supports loading prop (disabled buttons + spinner) and ReactNode message
- pnpm typecheck passes across the monorepo
</success_criteria>

<output>
After completion, create `.planning/phases/13-app-deletion-ui/13-01-SUMMARY.md`
</output>
