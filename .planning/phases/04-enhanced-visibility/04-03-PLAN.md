---
phase: 04-enhanced-visibility
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - dashboard/src/pages/Apps.tsx
  - dashboard/src/pages/Apps.module.css
  - dashboard/src/pages/Repositories.tsx
  - dashboard/src/pages/Repositories.module.css
  - dashboard/src/pages/Notifications.tsx
  - dashboard/src/pages/Notifications.module.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Apps page shows a searchable, sortable, paginated table instead of card grid"
    - "Repositories page has search, status filter dropdown, sortable columns, and pagination"
    - "Notifications page shows a sortable, searchable table instead of card list with pagination"
    - "Filter/search state persists in URL and survives page refresh"
    - "Filtered empty state shows 'No results match your filters' with 'Clear all filters' button"
    - "Page resets to 1 when filter/search/sort changes"
    - "Existing retry/resync actions still work on all pages"
  artifacts:
    - path: "dashboard/src/pages/Apps.tsx"
      provides: "Apps list page with DataTable, search, sort, pagination"
      contains: "useTableParams"
    - path: "dashboard/src/pages/Repositories.tsx"
      provides: "Repositories page with DataTable, search, status filter, sort, pagination"
      contains: "FilterBar"
    - path: "dashboard/src/pages/Notifications.tsx"
      provides: "Notifications page with DataTable, search, sort, pagination, retry actions"
      contains: "DataTable"
  key_links:
    - from: "dashboard/src/pages/Apps.tsx"
      to: "/admin/api/apps"
      via: "fetchApps with query params from useTableParams"
      pattern: "fetchApps.*page.*limit"
    - from: "dashboard/src/pages/Repositories.tsx"
      to: "/admin/api/repositories"
      via: "fetchRepositories with query params including status filter"
      pattern: "fetchRepositories.*status"
    - from: "dashboard/src/pages/Notifications.tsx"
      to: "/admin/api/notifications/failed"
      via: "fetchFailedNotifications with query params"
      pattern: "fetchFailedNotifications.*page"
---

<objective>
Rewrite Apps, Repositories, and Notifications pages to use server-side pagination with shared components.

Purpose: These three pages all use SQL-backed endpoints with server-side pagination. They share the same pattern: useTableParams for URL state, DataTable for display, FilterBar for search/filters, Pagination for navigation.

Output: Three fully functional paginated pages with search, sort, and filter capabilities.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-enhanced-visibility/04-RESEARCH.md
@.planning/phases/04-enhanced-visibility/04-01-SUMMARY.md
@.planning/phases/04-enhanced-visibility/04-02-SUMMARY.md

@dashboard/src/pages/Apps.tsx
@dashboard/src/pages/Repositories.tsx
@dashboard/src/pages/Notifications.tsx
@dashboard/src/api/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Apps page with table, search, sort, pagination</name>
  <files>
    dashboard/src/pages/Apps.tsx
    dashboard/src/pages/Apps.module.css
  </files>
  <action>
    Replace the card grid layout with a searchable, sortable, paginated table.

    **Apps.tsx rewrite:**
    1. Import: `useTableParams`, `DataTable` + `Column`, `Pagination`, `FilterBar`, `FilterChips`, `fetchApps` (updated), `keepPreviousData` from `@tanstack/react-query`, `usePollingQuery` (or switch to direct `useQuery` with `placeholderData: keepPreviousData`)
    2. Use `useTableParams({ sortBy: 'created_at', sortOrder: 'desc' })` for URL state
    3. Use `useQuery` (not `usePollingQuery`) with:
       - queryKey: `['apps', page, limit, sortBy, sortOrder, search]`
       - queryFn: `() => fetchApps({ page, limit, sort_by: sortBy, sort_order: sortOrder, search })`
       - `placeholderData: keepPreviousData` for smooth transitions
       - `refetchInterval: 10_000` to maintain polling behavior
    4. Define columns: `Column<AppSummary>[]`:
       - App Name (key: 'app_name', sortable, render: Link to `/apps/${app.app_id}` with app name)
       - URL (key: 'base_url', not sortable, render: truncated URL text)
       - Repositories (key: 'repository_count', sortable, render: count number)
       - Failed (key: 'failed_notification_count', sortable, render: count with red style if > 0)
       - Created (key: 'created_at', sortable, render: formatDistanceToNow)
    5. Sort handler: `handleSort(columnKey)` — implements cycling logic:
       - If different column: set sort_by=column, sort_order=asc
       - If same column + asc: set sort_order=desc
       - If same column + desc: clear sort (reset to defaults)
       - Calls `updateParams` which auto-resets page to 1
    6. Render: header with title + refresh, FilterBar (search only, no dropdown filters for apps per research), FilterChips (only for search), DataTable, Pagination
    7. Empty state: if no data AND no filters active, show existing "No apps registered" empty state. If no data AND filters active, show "No results match your filters" with "Clear all filters" button.
    8. Loading state: show spinner only on initial load. Use `isPlaceholderData` for subtle loading indicator during transitions.

    **Apps.module.css update:**
    - Remove `.appGrid`, `.appCard`, `.appName`, `.appUrl`, `.appStats`, `.stat`, `.statLabel`, `.statValue`, `.statValueError` classes (no longer needed)
    - Keep `.container`, `.header`, `.title`, `.refreshInfo`, `.refreshButton`, `.loadingState`, `.spin`, `.emptyState`, `.emptyTitle`, `.emptyText`
    - Add: `.failedCount` (red text for failed > 0), `.appLink` (blue underline link style for app names in table)
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora/dashboard && pnpm exec tsc --noEmit`. Verify no unused CSS classes remain.
  </verify>
  <done>
    Apps page shows a table with sortable columns (App Name, Repositories, Failed, Created), search box, pagination with page size selector, URL-synced state. Clicking app name navigates to detail. Empty state handles both no-data and no-results-matching-filters cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Repositories page with table, search, status filter, sort, pagination</name>
  <files>
    dashboard/src/pages/Repositories.tsx
    dashboard/src/pages/Repositories.module.css
  </files>
  <action>
    Add search, status filter, sorting, and pagination to the existing table layout.

    **Repositories.tsx rewrite:**
    1. Import: `useTableParams`, `DataTable` + `Column`, `Pagination`, `FilterBar` + `FilterConfig`, `FilterChips`, `fetchRepositories` (updated), `keepPreviousData`
    2. Use `useTableParams({ sortBy: 'created_at', sortOrder: 'desc' })`
    3. Read status filter: `const status = tableParams.getFilter('status')`
    4. Use `useQuery` with:
       - queryKey: `['repositories', page, limit, sortBy, sortOrder, search, status]`
       - queryFn: `() => fetchRepositories({ page, limit, sort_by: sortBy, sort_order: sortOrder, search, status })`
       - `placeholderData: keepPreviousData`
       - `refetchInterval: 10_000`
    5. Define filter config:
       ```
       const statusFilter: FilterConfig = {
         key: 'status',
         label: 'Status',
         options: [
           { value: 'synced', label: 'Synced' },
           { value: 'failed', label: 'Failed' },
           { value: 'pending_snapshot', label: 'Pending' },
           { value: 'scanning', label: 'Scanning' },
         ]
       }
       ```
    6. Define columns: `Column<RepositorySummary>[]`:
       - Repository (key: 'name', sortable, render: `owner/name` as GitHub link + circuit open badge)
       - App (key: 'app_name', not sortable, render: app name text — note: RepositorySummary may need app_name if not already present, check from 04-01)
       - Status (key: 'status', sortable, render: StatusBadge component)
       - Last Scanned (key: 'last_scanned_at', sortable, render: formatDistanceToNow or "Never")
       - Actions (key: 'actions', not sortable, render: Re-sync button)
    7. Keep existing resync mutation and ConfirmDialog logic
    8. Sort handler same cycling pattern as Apps
    9. Build chips array from search + status filter for FilterChips
    10. Handle filtered empty state with "Clear all filters" button

    **Repositories.module.css update:**
    - Remove `.table`, `thead`, `th`, `td`, `tr` styles (now handled by DataTable.module.css)
    - Keep `.container`, `.header`, `.title`, `.refreshInfo`, `.refreshButton`, `.loadingState`, `.spin`, `.emptyState`, `.emptyTitle`, `.emptyText`
    - Keep `.statusBadge`, `.statusSynced`, `.statusFailed`, `.statusPending`, `.statusScanning` (still used by StatusBadge inline component)
    - Keep `.circuitBadge`, `.repoLink`, `.resyncButton` styles
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora/dashboard && pnpm exec tsc --noEmit`.
  </verify>
  <done>
    Repositories page has search, status dropdown filter in collapsible panel, sortable columns (Repository, Status, Last Scanned), pagination. Re-sync buttons still work. Filter chips appear above table when active. Status filter persists in URL.
  </done>
</task>

<task type="auto">
  <name>Task 3: Rewrite Notifications page with table, search, sort, pagination</name>
  <files>
    dashboard/src/pages/Notifications.tsx
    dashboard/src/pages/Notifications.module.css
  </files>
  <action>
    Replace the card list layout with a searchable, sortable, paginated table. Preserve retry actions.

    **Notifications.tsx rewrite:**
    1. Import: `useTableParams`, `DataTable` + `Column`, `Pagination`, `FilterBar`, `FilterChips`, `fetchFailedNotifications` (updated), `keepPreviousData`
    2. Use `useTableParams({ sortBy: 'last_scanned_at', sortOrder: 'desc' })`
    3. Use `useQuery` with:
       - queryKey: `['notifications', 'failed', page, limit, sortBy, sortOrder, search]`
       - queryFn: `() => fetchFailedNotifications({ page, limit, sort_by: sortBy, sort_order: sortOrder, search })`
       - `placeholderData: keepPreviousData`
       - `refetchInterval: 10_000`
    4. Define columns: `Column<FailedNotification>[]`:
       - Repository (key: 'repository_name', sortable, render: GitHub link)
       - App (key: 'app_name', sortable, render: Link to `/apps/${app_id}`)
       - Error (key: 'error_message', not sortable, render: truncated error text with title tooltip)
       - Retries (key: 'retry_count', sortable, render: count with badge style)
       - Time (key: 'last_scanned_at', sortable, render: formatDistanceToNow)
       - Actions (key: 'actions', not sortable, render: Retry button)
    5. Keep existing retry mutation (single retry) and bulk retry logic
    6. Keep ConfirmDialog for "Retry All" confirmation
    7. Keep BulkProgress component for bulk operation feedback
    8. "Retry All" button should show the TOTAL count from pagination metadata (not just current page count). Use `data?.pagination.total ?? 0` for the count.
    9. Search: searches across app_name, repository_name, error_message (handled server-side)
    10. Filtered empty state with "Clear all filters" button
    11. Regular empty state (no filters): keep existing positive message "All notifications delivered"

    **Notifications.module.css update:**
    - Remove `.notificationList`, `.notificationCard`, `.notificationHeader`, `.notificationRepo`, `.headerActions`, `.notificationMeta`, `.metaItem`, `.errorMessage` (card layout removed)
    - Keep `.container`, `.header`, `.title`, `.refreshInfo`, `.refreshButton`, `.loadingState`, `.spin`, `.emptyState`, `.emptyIcon`, `.emptyTitle`, `.emptyText`
    - Keep `.bulkRetryButton`, `.retryButton`, `.retryBadge` (still used in table actions column)
    - Add: `.errorCell` (max-width for truncated error text, text-overflow: ellipsis)
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora/dashboard && pnpm exec tsc --noEmit`.
  </verify>
  <done>
    Notifications page shows a table with sortable columns (Repository, App, Error, Retries, Time), search, pagination. Single retry buttons work per row. Bulk "Retry All" shows total count from pagination. BulkProgress component still works. Card layout replaced with table.
  </done>
</task>

</tasks>

<verification>
- All three pages compile without TypeScript errors
- Apps, Repositories, Notifications show paginated tables with sort indicators
- Search is debounced and synced to URL
- Repositories page has status filter dropdown in collapsible panel
- Filter chips appear above table when filters/search are active
- Retry/resync buttons still functional on Repositories and Notifications pages
- Empty states differentiate between "no data" and "no matching results"
- Page number resets to 1 on any filter/search/sort change
- Refreshing the page preserves filter/search/sort/page state from URL
</verification>

<success_criteria>
Three SQL-backed pages (Apps, Repositories, Notifications) display paginated, sortable, searchable tables with URL-synced state. All existing action buttons (retry, resync) continue to work. Visual design matches existing dashboard theme.
</success_criteria>

<output>
After completion, create `.planning/phases/04-enhanced-visibility/04-03-SUMMARY.md`
</output>
