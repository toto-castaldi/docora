---
phase: 03-retry-operations-actions
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - src/services/admin-actions.ts
  - src/routes/admin/dashboard-actions.ts
  - dashboard/src/api/admin.ts
  - dashboard/src/pages/Repositories.tsx
  - dashboard/src/pages/Repositories.module.css
  - dashboard/src/pages/AppDetail.tsx
  - dashboard/src/pages/AppDetail.module.css
autonomous: true

must_haves:
  truths:
    - "Admin can force re-sync a single repository from the Repositories page"
    - "Admin can force re-sync all repositories for an app from AppDetail page"
    - "Re-sync clears delivery records and queues a fresh snapshot job"
    - "Confirmation dialog warns about re-sync impact (will re-send all files to clients)"
    - "Re-sync available on ANY repository, not just failed ones"
    - "Per-app re-sync shows live progress (reuses BulkProgress component)"
  artifacts:
    - path: "src/services/admin-actions.ts"
      provides: "resyncSingle and resyncByApp functions"
      exports: ["resyncSingle", "resyncByApp"]
    - path: "src/routes/admin/dashboard-actions.ts"
      provides: "POST /admin/api/resync and /admin/api/resync/app/:appId endpoints"
      contains: "admin/api/resync"
    - path: "dashboard/src/pages/Repositories.tsx"
      provides: "Re-sync button on each repository row"
      contains: "resyncRepository"
    - path: "dashboard/src/pages/AppDetail.tsx"
      provides: "Re-sync All button for app-level re-sync"
      contains: "resyncByApp"
  key_links:
    - from: "src/services/admin-actions.ts"
      to: "src/repositories/deliveries.ts"
      via: "clearDeliveries call for re-sync"
      pattern: "clearDeliveries"
    - from: "dashboard/src/pages/Repositories.tsx"
      to: "dashboard/src/api/admin.ts"
      via: "resyncRepository mutation"
      pattern: "resyncRepository"
    - from: "dashboard/src/pages/AppDetail.tsx"
      to: "dashboard/src/components/BulkProgress.tsx"
      via: "Shows progress for per-app re-sync"
      pattern: "BulkProgress"
---

<objective>
Add force re-sync capability: backend endpoints for single and per-app re-sync, and frontend UI with re-sync buttons on Repositories and AppDetail pages.

Purpose: Enables admin to recover from edge cases by forcing a full re-sync that re-delivers all files to clients.
Output: Working re-sync buttons with confirmation dialogs and progress tracking for bulk operations.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-retry-operations-actions/03-03-SUMMARY.md
@.planning/phases/03-retry-operations-actions/03-04-SUMMARY.md
@src/services/admin-actions.ts
@src/routes/admin/dashboard-actions.ts
@src/repositories/deliveries.ts
@src/services/bulk-progress.ts
@dashboard/src/api/admin.ts
@dashboard/src/pages/Repositories.tsx
@dashboard/src/pages/Repositories.module.css
@dashboard/src/pages/AppDetail.tsx
@dashboard/src/pages/AppDetail.module.css
@dashboard/src/components/ConfirmDialog.tsx
@dashboard/src/components/BulkProgress.tsx
@packages/shared-types/src/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-sync backend service functions and endpoints</name>
  <files>
    src/services/admin-actions.ts
    src/routes/admin/dashboard-actions.ts
  </files>
  <action>
    **Add to admin-actions.ts:**

    1. Import `clearDeliveries` from `../repositories/deliveries.js`

    2. `resyncSingle(appId: string, repositoryId: string): Promise<{ jobId: string }>`
       - Query app_repositories joined with apps and repositories to get SnapshotJobData fields
       - Validate the app-repository link exists (throw if not found)
       - NOTE: Do NOT validate status -- re-sync works on any status (synced, failed, pending_snapshot, scanning)
       - Call `clearDeliveries(appId, repositoryId)` to wipe delivery records
       - Update app_repositories: SET status='pending_snapshot', retry_count=0, last_error=NULL
       - Check for existing active/waiting/delayed job. If found, return existing job ID
       - Queue BullMQ job with `isRescan: false` (treated as initial scan since deliveries cleared)
       - Return { jobId }

    3. `resyncByApp(appId: string): Promise<{ operationId: string; total: number }>`
       - Query ALL app_repositories for this app (not just failed -- re-sync works on any)
       - If none found, throw Error("No repositories for this app")
       - Create progress tracker: `createProgress(operationId, total)`
       - Fire-and-forget async IIFE that processes each repo sequentially:
         a. Check `isCancelled(operationId)` -- break if true
         b. Try: clearDeliveries, reset status, queue job, incrementProgress(true)
         c. Catch: incrementProgress(false)
       - Return { operationId, total }

    **Add endpoints to dashboard-actions.ts (or dashboard-bulk-actions.ts if file was split in Plan 03):**

    1. `POST /admin/api/resync` -- body: `{ app_id, repository_id }`, calls resyncSingle, returns `{ data: { message: "Re-sync queued", job_id } }`
    2. `POST /admin/api/resync/app/:appId` -- calls resyncByApp, returns `{ data: { message, operation_id, total } }`

    Error handling: 404 for "not found", 500 for unexpected errors.

    Use same progress/cancel endpoints from Plan 03 (GET /admin/api/retry/progress/:operationId works for re-sync operations too since they share the same Redis tracking).
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm typecheck && pnpm build` -- both pass.
  </verify>
  <done>
    resyncSingle and resyncByApp functions in admin-actions.ts. POST /admin/api/resync and /admin/api/resync/app/:appId endpoints registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-sync frontend UI on Repositories and AppDetail pages</name>
  <files>
    dashboard/src/api/admin.ts
    dashboard/src/pages/Repositories.tsx
    dashboard/src/pages/Repositories.module.css
    dashboard/src/pages/AppDetail.tsx
    dashboard/src/pages/AppDetail.module.css
  </files>
  <action>
    **Add API functions to admin.ts:**
    ```typescript
    export async function resyncRepository(appId: string, repositoryId: string): Promise<RetryResponse> {
      return postApi<RetryResponse>("/api/resync", { app_id: appId, repository_id: repositoryId });
    }
    export async function resyncByApp(appId: string): Promise<BulkRetryResponse> {
      return postApi<BulkRetryResponse>("/api/resync/app/" + appId, {});
    }
    ```

    **Repositories.tsx changes:**

    NOTE: The Repositories page currently shows repos without app_id context. The RepositorySummary type does not include app_id. For the re-sync button to work, we need the app_id. Two options:
    - Option A: Extend the /admin/api/repositories endpoint to include app_id in response (requires backend type change)
    - Option B: Add re-sync button only on AppDetail page where app_id is known

    Choose Option A: Extend RepositorySummary in shared-types to optionally include `app_id?: string`, and update the repositories endpoint + admin-dashboard repository to include app_id. The admin-dashboard.ts `listAllRepositories` already returns `app_id` -- just add it to the RepositorySummary type and the endpoint mapping.

    1. In `packages/shared-types/src/dashboard.ts`: Add `app_id?: string` to RepositorySummary interface
    2. In `src/routes/admin/dashboard-api.ts`: Add `app_id: repo.app_id` to the repositories endpoint mapping (for the /admin/api/repositories route only -- the AppDetail endpoint already has app context)
    3. Import `useMutation, useQueryClient` from `@tanstack/react-query`, `toast` from `react-hot-toast`, `ConfirmDialog` from components, `resyncRepository` from api
    4. Import `RefreshCcw` from lucide-react for re-sync icon
    5. Add state: `resyncTarget` (null or {appId, repoId, repoName} for confirm dialog)
    6. Add resync mutation:
       ```typescript
       const resyncMutation = useMutation({
         mutationFn: ({ appId, repositoryId }: { appId: string; repositoryId: string }) =>
           resyncRepository(appId, repositoryId),
         onSuccess: () => { toast.success("Re-sync queued"); queryClient.invalidateQueries({ queryKey: ["repositories"] }); },
         onError: (error: Error) => { toast.error(error.message); },
       });
       ```
    7. Add "Actions" column to the table with a Re-sync button for each row:
       - Button shows RefreshCcw icon + "Re-sync"
       - On click: set resyncTarget to open confirm dialog
       - Disabled while mutation is pending for that specific repo
    8. ConfirmDialog with variant "warning" and message: "This will re-sync {repoName} and re-send ALL files to the client app. This may trigger many notifications. Continue?"

    **Repositories.module.css:**
    Add `.resyncButton` -- inline button, background transparent, border 1px solid #555, color #ccc, padding 0.25rem 0.5rem, border-radius 4px, gap 0.25rem, hover: border-color #888. `.resyncButton:disabled` opacity 0.5.

    **AppDetail.tsx changes:**
    1. Import `resyncRepository` and `resyncByApp` from api/admin
    2. Import `RefreshCcw` from lucide-react
    3. Add per-repo re-sync: Add "Actions" column to the repositories table (if not already added by Plan 02 for retry). Each row gets a Re-sync button with confirmation.
    4. Add per-app re-sync: A "Re-sync All Repos" button in the section header next to "Retry All Failed" (already added in Plan 04). This uses bulk progress tracking from resyncByApp.
    5. Add state for re-sync confirm dialog (separate from bulk retry state):
       - `resyncTarget` for single repo confirm
       - `showResyncAllConfirm` for bulk re-sync confirm
       - `resyncOperationId` for bulk progress
    6. BulkProgress renders when resyncOperationId is set (reuses same component from Plan 04)
    7. ConfirmDialog for bulk re-sync: "This will re-sync all {app.repository_count} repositories for {app.app_name}. ALL files will be re-sent to the client. Continue?" with variant "danger"

    **AppDetail.module.css:**
    Add `.resyncButton` matching Repositories style. Add `.resyncAllButton` similar to bulkRetryButton but distinct color (use #6366f1 indigo for re-sync to distinguish from amber retry).
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm --filter dashboard build && pnpm typecheck` -- both pass.
  </verify>
  <done>
    - Re-sync button on each repo row in both Repositories and AppDetail pages
    - "Re-sync All" button on AppDetail page for per-app bulk re-sync
    - Confirmation dialog before all re-sync operations
    - Bulk re-sync shows live progress via BulkProgress component
    - RepositorySummary extended with optional app_id for Repositories page
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- `pnpm --filter dashboard build` succeeds
- Re-sync endpoints return correct responses
- clearDeliveries called before queueing re-sync job
- Confirmation dialog shown for all re-sync operations
- BulkProgress works for per-app re-sync
</verification>

<success_criteria>
- Admin can re-sync any repository (not just failed ones) from Repositories page
- Admin can re-sync any repository from AppDetail page
- Admin can re-sync all repos for an app with bulk progress
- Confirmation dialogs warn about impact (re-sends all files)
- All re-sync operations show appropriate feedback (toast + loading state)
</success_criteria>

<output>
After completion, create `.planning/phases/03-retry-operations-actions/03-05-SUMMARY.md`
</output>
