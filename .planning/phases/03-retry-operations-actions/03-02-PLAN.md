---
phase: 03-retry-operations-actions
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - dashboard/src/api/admin.ts
  - dashboard/src/pages/Notifications.tsx
  - dashboard/src/pages/Notifications.module.css
  - dashboard/src/pages/AppDetail.tsx
  - dashboard/src/pages/AppDetail.module.css
autonomous: true

must_haves:
  truths:
    - "Each failed notification card has a Retry button"
    - "Clicking Retry shows loading state, then toast success/error"
    - "After successful retry, notification status changes from Failed to Pending inline"
    - "Retry button appears on both Notifications page and AppDetail page (for failed repos)"
  artifacts:
    - path: "dashboard/src/api/admin.ts"
      provides: "postApi helper function and retryNotification mutation function"
      contains: "postApi"
    - path: "dashboard/src/pages/Notifications.tsx"
      provides: "Retry button on each failed notification card"
      contains: "useMutation"
    - path: "dashboard/src/pages/AppDetail.tsx"
      provides: "Retry button on failed repository rows"
      contains: "useMutation"
  key_links:
    - from: "dashboard/src/pages/Notifications.tsx"
      to: "dashboard/src/api/admin.ts"
      via: "retryNotification function call in useMutation"
      pattern: "retryNotification"
    - from: "dashboard/src/api/admin.ts"
      to: "/admin/api/retry"
      via: "postApi POST request"
      pattern: "postApi.*api/retry"
---

<objective>
Add single retry capability to the frontend: a postApi helper for POST requests, a retry mutation function, and Retry buttons on both the Notifications page and AppDetail page.

Purpose: Enables the admin to retry any individual failed notification with one click, seeing immediate feedback.
Output: Working retry buttons on both pages that queue a retry job and update the UI.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-retry-operations-actions/03-01-SUMMARY.md
@dashboard/src/api/admin.ts
@dashboard/src/pages/Notifications.tsx
@dashboard/src/pages/Notifications.module.css
@dashboard/src/pages/AppDetail.tsx
@dashboard/src/pages/AppDetail.module.css
@packages/shared-types/src/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add postApi helper and retry mutation function</name>
  <files>
    dashboard/src/api/admin.ts
  </files>
  <action>
    Add a `postApi` helper to `dashboard/src/api/admin.ts` alongside the existing `fetchApi`:

    ```typescript
    async function postApi<T>(endpoint: string, body: unknown): Promise<T> {
      const response = await fetch(`/admin${endpoint}`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        const errorData = (await response.json().catch(() => ({
          error: "Unknown error",
        }))) as ApiErrorResponse;
        throw new ApiError(errorData.error, response.status);
      }

      const data = (await response.json()) as ApiResponse<T>;
      return data.data;
    }
    ```

    Add retry function:
    ```typescript
    export async function retryNotification(appId: string, repositoryId: string): Promise<RetryResponse> {
      return postApi<RetryResponse>("/api/retry", { app_id: appId, repository_id: repositoryId });
    }
    ```

    Import `RetryResponse` from `@docora/shared-types`.
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm --filter dashboard build` -- builds without errors.
  </verify>
  <done>
    postApi helper and retryNotification function exported from admin.ts, using correct types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry buttons to Notifications and AppDetail pages</name>
  <files>
    dashboard/src/pages/Notifications.tsx
    dashboard/src/pages/Notifications.module.css
    dashboard/src/pages/AppDetail.tsx
    dashboard/src/pages/AppDetail.module.css
  </files>
  <action>
    **Notifications.tsx changes:**
    1. Import `useMutation, useQueryClient` from `@tanstack/react-query`
    2. Import `toast` from `react-hot-toast`
    3. Import `retryNotification` from `../api/admin`
    4. Import `RotateCw` icon from lucide-react (for retry button, distinct from existing RotateCcw)
    5. Inside the `Notifications` component, add:
       - `const queryClient = useQueryClient()`
       - A `useMutation` hook:
         ```
         const retryMutation = useMutation({
           mutationFn: ({ appId, repositoryId }: { appId: string; repositoryId: string }) =>
             retryNotification(appId, repositoryId),
           onSuccess: () => {
             toast.success("Retry queued successfully");
             queryClient.invalidateQueries({ queryKey: ["notifications"] });
             queryClient.invalidateQueries({ queryKey: ["overview"] });
           },
           onError: (error: Error) => {
             toast.error(error.message || "Failed to queue retry");
           },
         })
         ```
    6. Add a Retry button to each notification card, positioned in the card header next to the retry badge:
       ```jsx
       <button
         onClick={() => retryMutation.mutate({ appId: notification.app_id, repositoryId: notification.repository_id })}
         disabled={retryMutation.isPending && retryMutation.variables?.appId === notification.app_id && retryMutation.variables?.repositoryId === notification.repository_id}
         className={styles.retryButton}
       >
         {retryMutation.isPending && retryMutation.variables?.appId === notification.app_id && retryMutation.variables?.repositoryId === notification.repository_id
           ? <Loader2 size={14} className={styles.spin} />
           : <RotateCw size={14} />}
         Retry
       </button>
       ```
    7. Place the retry button in the card header area, right side, next to the existing retry count badge.

    **Notifications.module.css changes:**
    Add `.retryButton` style matching the existing `.refreshButton` pattern but smaller/inline:
    - display: inline-flex, align-items: center, gap: 0.25rem
    - background: var(--accent) or #3b82f6, color: white, border: none
    - border-radius: 4px, padding: 0.25rem 0.5rem, font-size: 0.75rem
    - cursor: pointer, transition: opacity 0.2s
    - &:hover opacity 0.8, &:disabled opacity 0.5 cursor not-allowed

    **AppDetail.tsx changes:**
    1. Same imports as Notifications (useMutation, useQueryClient, toast, retryNotification, RotateCw, Loader2)
    2. Add same retryMutation hook pattern inside AppDetail component
    3. In the repositories table, add a new "Actions" column header
    4. For each repo row, add a table cell with:
       - If `repo.status === "failed"`: show Retry button (same style as Notifications)
       - Otherwise: show "---" or empty cell
    5. Also invalidate `["app", appId]` query on success to refresh the app detail data

    **AppDetail.module.css changes:**
    Add `.retryButton` style matching Notifications pattern.

    Per user decision (Claude's discretion): Use inline status badge change after retry -- the notification card stays but its retry badge text changes to show "Retry queued". Do NOT remove the row. The polling will eventually refresh the list and the item will disappear when status changes to pending_snapshot.
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm --filter dashboard build` -- builds without errors.
  </verify>
  <done>
    - Each failed notification card on Notifications page has a Retry button with loading state
    - Each failed repository row on AppDetail page has a Retry button
    - Clicking Retry shows loading spinner, then toast success/error
    - Query cache invalidated on success so polling picks up changes
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter dashboard build` passes
- `pnpm typecheck` passes
- Notifications.tsx imports and uses retryNotification from api/admin
- AppDetail.tsx imports and uses retryNotification from api/admin
- Both pages use useMutation with onSuccess/onError handlers
- postApi helper exists in admin.ts for POST requests
</verification>

<success_criteria>
- Retry button visible on each failed notification card
- Retry button visible on each failed repo row in AppDetail
- Loading state shown during retry mutation
- Toast notification on success/error
- Query cache invalidated after successful retry
</success_criteria>

<output>
After completion, create `.planning/phases/03-retry-operations-actions/03-02-SUMMARY.md`
</output>
