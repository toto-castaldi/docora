---
phase: 03-retry-operations-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared-types/src/dashboard.ts
  - src/services/admin-actions.ts
  - src/routes/admin/dashboard-actions.ts
  - src/routes/admin/index.ts
autonomous: true

must_haves:
  truths:
    - "POST /admin/api/retry with valid app_id+repository_id returns 200 and queues a BullMQ job"
    - "Single retry resets status to pending_snapshot, clears retry_count and last_error"
    - "Duplicate job submission is prevented (checks existing active/waiting jobs)"
  artifacts:
    - path: "packages/shared-types/src/dashboard.ts"
      provides: "RetryRequest, RetryResponse, BulkRetryResponse, ResyncRequest, BulkProgressResponse types"
      contains: "RetryRequest"
    - path: "src/services/admin-actions.ts"
      provides: "retrySingle function orchestrating DB reset + job queue"
      exports: ["retrySingle"]
    - path: "src/routes/admin/dashboard-actions.ts"
      provides: "POST /admin/api/retry endpoint with session auth"
      exports: ["dashboardActionRoutes"]
    - path: "src/routes/admin/index.ts"
      provides: "Registration of dashboardActionRoutes"
      contains: "dashboardActionRoutes"
  key_links:
    - from: "src/routes/admin/dashboard-actions.ts"
      to: "src/services/admin-actions.ts"
      via: "import retrySingle"
      pattern: "retrySingle"
    - from: "src/services/admin-actions.ts"
      to: "src/repositories/repositories.ts"
      via: "updateAppRepositoryStatus + resetRetryCount"
      pattern: "updateAppRepositoryStatus|resetRetryCount"
    - from: "src/services/admin-actions.ts"
      to: "bullmq Queue.add"
      via: "snapshot queue job submission"
      pattern: "queue\\.add"
---

<objective>
Create the backend foundation for retry operations: shared types for all action endpoints, an admin-actions service for single retry orchestration, and the first POST endpoint.

Purpose: Enables the core "retry a failed notification" capability that all other actions build upon.
Output: Working POST /admin/api/retry endpoint that resets a failed app-repository pair and queues a BullMQ snapshot job.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/shared-types/src/dashboard.ts
@src/routes/admin/dashboard-api.ts
@src/services/queue-status.ts
@src/repositories/repositories.ts
@src/repositories/admin-dashboard.ts
@src/workers/snapshot.worker.ts
@src/workers/snapshot.scheduler.ts
@src/routes/admin/index.ts
@src/queue/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared action types and admin-actions service</name>
  <files>
    packages/shared-types/src/dashboard.ts
    src/services/admin-actions.ts
  </files>
  <action>
    1. Extend `packages/shared-types/src/dashboard.ts` with new types (append after existing types):
       - `RetryRequest { app_id: string; repository_id: string }` - single retry request body
       - `RetryResponse { message: string; job_id: string }` - single retry success response
       - `BulkRetryResponse { message: string; operation_id: string; total: number }` - bulk retry response (used by later plans)
       - `BulkProgressResponse { operation_id: string; total: number; completed: number; succeeded: number; failed: number; cancelled: boolean }` - progress polling response
       - `ResyncRequest { app_id: string; repository_id: string }` - single re-sync request body

    2. Create `src/services/admin-actions.ts` with function `retrySingle(appId: string, repositoryId: string)`:
       - Import `getDatabase` from `../db/index.js`
       - Import `Queue` from `bullmq`
       - Import `getRedisUrl, getRedisOptions` from `../queue/connection.js`
       - Import `SNAPSHOT_QUEUE_NAME, SnapshotJobData` from `../workers/snapshot.worker.js`
       - Lazy-initialize a BullMQ Queue instance (same pattern as `queue-status.ts` getQueue)
       - Query app_repositories joined with apps and repositories to get all data needed for SnapshotJobData (app_id, app_name, repository_id, github_url, owner, name, base_url, github_token_encrypted, client_auth_key_encrypted)
       - Validate the link exists, throw Error("App-repository link not found") if missing
       - Validate current status is "failed" -- throw Error("Only failed entries can be retried") if not failed
       - Reset: UPDATE app_repositories SET status='pending_snapshot', retry_count=0, last_error=NULL WHERE app_id AND repository_id
       - Check for existing active/waiting/delayed job with jobId pattern `{app_id}-{repository_id}`. If found, skip queue.add and return the existing job ID
       - Queue BullMQ job: `queue.add("snapshot", jobData, { jobId })` with jobId = `{appId}-{repositoryId}`
       - Return `{ jobId: string }` with the queued or existing job ID
       - Export a `closeActionQueue()` function for cleanup

    Keep file under 150 lines. Use early returns for validation. Follow existing patterns from queue-status.ts for queue initialization.
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm typecheck` -- no type errors.
  </verify>
  <done>
    Shared action types exist in dashboard.ts. admin-actions.ts exports retrySingle that validates, resets status, and queues a BullMQ job.
  </done>
</task>

<task type="auto">
  <name>Task 2: Single retry endpoint and route registration</name>
  <files>
    src/routes/admin/dashboard-actions.ts
    src/routes/admin/index.ts
  </files>
  <action>
    1. Create `src/routes/admin/dashboard-actions.ts`:
       - Follow the exact pattern of `dashboard-api.ts` for structure (Fastify plugin, session auth hook)
       - Add session auth onRequest hook (same as dashboard-api.ts: check request.session?.get("adminId"), return 401 if missing)
       - POST `/admin/api/retry` endpoint:
         - Body schema: `{ app_id: string, repository_id: string }` -- validate both are present, return 400 if missing
         - Call `retrySingle(app_id, repository_id)` from admin-actions service
         - On success: return 200 with `{ data: { message: "Retry queued", job_id } }` matching ApiResponse<RetryResponse>
         - On "not found" error: return 404 with `{ error: "App-repository link not found" }`
         - On "only failed" error: return 409 with `{ error: "Only failed entries can be retried" }`
         - On other error: return 500 with `{ error: "Failed to queue retry" }`
       - Import types from @docora/shared-types

    2. Update `src/routes/admin/index.ts`:
       - Import `dashboardActionRoutes` from `./dashboard-actions.js`
       - Register it: `await server.register(dashboardActionRoutes)` AFTER dashboardApiRoutes and BEFORE staticRoutes

    Keep dashboard-actions.ts under 80 lines (single endpoint for now, more added in later plans).
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm typecheck && pnpm build` -- both pass without errors.
  </verify>
  <done>
    POST /admin/api/retry endpoint exists, requires session auth, validates input, calls admin-actions service, returns structured responses. Route is registered in admin index.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- Types RetryRequest, RetryResponse, BulkRetryResponse, BulkProgressResponse, ResyncRequest exported from @docora/shared-types
- src/services/admin-actions.ts exports retrySingle and closeActionQueue
- src/routes/admin/dashboard-actions.ts exports dashboardActionRoutes
- Route registered in src/routes/admin/index.ts
</verification>

<success_criteria>
- Single retry endpoint is fully wired: route -> service -> DB + queue
- Session auth protects the endpoint
- Input validation returns appropriate error codes (400, 404, 409)
- Duplicate job prevention avoids re-queuing active jobs
- All new code type-checks and builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-retry-operations-actions/03-01-SUMMARY.md`
</output>
