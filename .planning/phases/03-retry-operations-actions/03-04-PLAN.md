---
phase: 03-retry-operations-actions
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - dashboard/src/components/ConfirmDialog.tsx
  - dashboard/src/components/ConfirmDialog.module.css
  - dashboard/src/components/BulkProgress.tsx
  - dashboard/src/components/BulkProgress.module.css
  - dashboard/src/api/admin.ts
  - dashboard/src/pages/Notifications.tsx
  - dashboard/src/pages/Notifications.module.css
  - dashboard/src/pages/AppDetail.tsx
  - dashboard/src/pages/AppDetail.module.css
autonomous: true

must_haves:
  truths:
    - "Admin can trigger bulk retry for all failed notifications of an app"
    - "Admin can trigger global retry of all failed notifications across all apps"
    - "Confirmation dialog appears before starting bulk retry"
    - "Live progress counter shows N/M completed, updating every 2 seconds"
    - "Cancel button stops remaining retries"
    - "After bulk retry completes, notification list refreshes"
  artifacts:
    - path: "dashboard/src/components/ConfirmDialog.tsx"
      provides: "Reusable confirmation dialog using native HTML dialog element"
      exports: ["ConfirmDialog"]
    - path: "dashboard/src/components/BulkProgress.tsx"
      provides: "Progress bar with counter and cancel button"
      exports: ["BulkProgress"]
    - path: "dashboard/src/api/admin.ts"
      provides: "bulkRetryByApp, bulkRetryAll, fetchRetryProgress, cancelRetry functions"
      contains: "bulkRetryByApp"
  key_links:
    - from: "dashboard/src/pages/Notifications.tsx"
      to: "dashboard/src/components/BulkProgress.tsx"
      via: "Renders BulkProgress when bulk operation active"
      pattern: "BulkProgress"
    - from: "dashboard/src/components/BulkProgress.tsx"
      to: "dashboard/src/api/admin.ts"
      via: "Polls fetchRetryProgress every 2s"
      pattern: "fetchRetryProgress"
    - from: "dashboard/src/pages/Notifications.tsx"
      to: "dashboard/src/components/ConfirmDialog.tsx"
      via: "Shows ConfirmDialog before bulk retry"
      pattern: "ConfirmDialog"
---

<objective>
Build the bulk retry frontend: a reusable ConfirmDialog, a BulkProgress component with live counter and cancel button, and integrate both into the Notifications and AppDetail pages.

Purpose: Delivers the "fix everything with one click" experience with live feedback and control.
Output: Working bulk retry UI with confirmation, live progress tracking, and cancellation.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-retry-operations-actions/03-02-SUMMARY.md
@.planning/phases/03-retry-operations-actions/03-03-SUMMARY.md
@dashboard/src/api/admin.ts
@dashboard/src/pages/Notifications.tsx
@dashboard/src/pages/Notifications.module.css
@dashboard/src/pages/AppDetail.tsx
@dashboard/src/pages/AppDetail.module.css
@dashboard/src/hooks/usePolling.ts
@packages/shared-types/src/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ConfirmDialog and BulkProgress components + API functions</name>
  <files>
    dashboard/src/components/ConfirmDialog.tsx
    dashboard/src/components/ConfirmDialog.module.css
    dashboard/src/components/BulkProgress.tsx
    dashboard/src/components/BulkProgress.module.css
    dashboard/src/api/admin.ts
  </files>
  <action>
    **1. Add API functions to admin.ts:**
    ```typescript
    export async function bulkRetryByApp(appId: string): Promise<BulkRetryResponse> {
      return postApi<BulkRetryResponse>("/api/retry/app/" + appId, {});
    }
    export async function bulkRetryAll(): Promise<BulkRetryResponse> {
      return postApi<BulkRetryResponse>("/api/retry/all", {});
    }
    export async function fetchRetryProgress(operationId: string): Promise<BulkProgressResponse> {
      return fetchApi<BulkProgressResponse>("/api/retry/progress/" + operationId);
    }
    export async function cancelRetry(operationId: string): Promise<void> {
      await postApi<{ message: string }>("/api/retry/cancel/" + operationId, {});
    }
    ```
    Import `BulkRetryResponse, BulkProgressResponse` from `@docora/shared-types`.

    **2. Create ConfirmDialog.tsx:**
    - Props: `{ open: boolean; title: string; message: string; confirmLabel?: string; cancelLabel?: string; onConfirm: () => void; onCancel: () => void; variant?: "danger" | "warning" }`
    - Use native HTML `<dialog>` element with `ref` and `useEffect` to call `showModal()`/`close()` based on `open` prop
    - Render: title, message paragraph, two buttons (Cancel left, Confirm right)
    - Confirm button styled based on variant (red for danger, orange for warning)
    - Handle Escape key via dialog's native cancel event -> call onCancel
    - Handle backdrop click -> call onCancel

    **3. Create ConfirmDialog.module.css:**
    - `.dialog` -- border: none, border-radius: 8px, padding: 1.5rem, max-width: 420px, background: #1e1e2e (dark theme matching dashboard)
    - `.dialog::backdrop` -- background: rgba(0,0,0,0.5)
    - `.title` -- font-size: 1.1rem, font-weight: 600, margin-bottom: 0.5rem, color: #e0e0e0
    - `.message` -- color: #a0a0a0, margin-bottom: 1.5rem, line-height: 1.5
    - `.actions` -- display: flex, justify-content: flex-end, gap: 0.75rem
    - `.cancelButton` -- background: transparent, border: 1px solid #444, color: #ccc, padding: 0.5rem 1rem, border-radius: 6px
    - `.confirmButton` -- padding: 0.5rem 1rem, border: none, border-radius: 6px, color: white, cursor: pointer
    - `.confirmDanger` -- background: #ef4444
    - `.confirmWarning` -- background: #f59e0b

    **4. Create BulkProgress.tsx:**
    - Props: `{ operationId: string; onComplete: () => void; onCancel: () => void }`
    - Uses `useQuery` with `queryKey: ["bulk-progress", operationId]`, `queryFn: () => fetchRetryProgress(operationId)`, `refetchInterval: 2000` (poll every 2s)
    - When `progress.completed >= progress.total` or `progress.cancelled`: stop polling (`refetchInterval: false`), call `onComplete()` after a short delay (1s for user to see final state)
    - Render:
      - A progress bar (div with width percentage based on completed/total)
      - Counter text: "{completed}/{total} completed ({succeeded} succeeded, {failed} failed)"
      - Cancel button (calls cancelRetry then onCancel) -- only show if not yet complete
      - If cancelled: show "Cancelled" label
    - Loading state: show "Starting..." while first poll returns

    **5. Create BulkProgress.module.css:**
    - `.container` -- background: #1e1e2e, border-radius: 8px, padding: 1rem, margin-bottom: 1rem, border: 1px solid #333
    - `.progressBar` -- height: 6px, background: #333, border-radius: 3px, overflow: hidden, margin-bottom: 0.75rem
    - `.progressFill` -- height: 100%, background: #3b82f6, transition: width 0.3s ease
    - `.stats` -- display: flex, justify-content: space-between, align-items: center, font-size: 0.85rem, color: #a0a0a0
    - `.cancelButton` -- background: transparent, border: 1px solid #666, color: #ccc, padding: 0.25rem 0.75rem, border-radius: 4px, cursor: pointer, font-size: 0.8rem
    - `.cancelled` -- color: #f59e0b, font-weight: 500
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm --filter dashboard build` -- builds without errors.
  </verify>
  <done>
    ConfirmDialog and BulkProgress components created. API functions for bulk operations exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate bulk retry into Notifications and AppDetail pages</name>
  <files>
    dashboard/src/pages/Notifications.tsx
    dashboard/src/pages/Notifications.module.css
    dashboard/src/pages/AppDetail.tsx
    dashboard/src/pages/AppDetail.module.css
  </files>
  <action>
    **Notifications.tsx changes:**
    1. Import `ConfirmDialog` from `../components/ConfirmDialog`
    2. Import `BulkProgress` from `../components/BulkProgress`
    3. Import `bulkRetryAll` from `../api/admin`
    4. Import `toast` from `react-hot-toast` (if not already imported from Plan 02)
    5. Add state:
       - `const [showConfirm, setShowConfirm] = useState(false)`
       - `const [bulkOperationId, setBulkOperationId] = useState<string | null>(null)`
    6. Add bulk retry handler:
       ```typescript
       const handleBulkRetryAll = async () => {
         setShowConfirm(false);
         try {
           const result = await bulkRetryAll();
           setBulkOperationId(result.operation_id);
           toast.success(`Retrying ${result.total} failed notifications...`);
         } catch (error) {
           toast.error((error as Error).message || "Failed to start bulk retry");
         }
       };
       ```
    7. Add "Retry All Failed" button in the header area (next to refresh button), only shown when notifications exist and no bulk operation is active:
       ```jsx
       {notifications && notifications.length > 0 && !bulkOperationId && (
         <button onClick={() => setShowConfirm(true)} className={styles.bulkRetryButton}>
           <RotateCw size={14} />
           Retry All ({notifications.length})
         </button>
       )}
       ```
    8. Show BulkProgress below header when bulkOperationId is set:
       ```jsx
       {bulkOperationId && (
         <BulkProgress
           operationId={bulkOperationId}
           onComplete={() => { setBulkOperationId(null); queryClient.invalidateQueries({ queryKey: ["notifications"] }); queryClient.invalidateQueries({ queryKey: ["overview"] }); }}
           onCancel={() => { setBulkOperationId(null); queryClient.invalidateQueries({ queryKey: ["notifications"] }); }}
         />
       )}
       ```
    9. Render ConfirmDialog:
       ```jsx
       <ConfirmDialog
         open={showConfirm}
         title="Retry All Failed Notifications"
         message={`This will retry all ${notifications?.length ?? 0} failed notifications across all apps. Continue?`}
         confirmLabel="Retry All"
         variant="warning"
         onConfirm={handleBulkRetryAll}
         onCancel={() => setShowConfirm(false)}
       />
       ```

    **Notifications.module.css:**
    Add `.bulkRetryButton` -- similar to retryButton but slightly larger: padding 0.375rem 0.75rem, font-size 0.8rem, background #f59e0b (amber for bulk action distinction), gap 0.375rem.

    **AppDetail.tsx changes:**
    1. Import ConfirmDialog, BulkProgress
    2. Import `bulkRetryByApp` from `../api/admin`
    3. Add same state pattern (showConfirm, bulkOperationId)
    4. Add "Retry All Failed" button in the section header for repositories, shown only when app has failed_notification_count > 0 and no active operation
    5. Show BulkProgress below the repositories section title when active
    6. ConfirmDialog with message: `This will retry all ${app.failed_notification_count} failed notifications for ${app.app_name}. Continue?`
    7. Handler calls `bulkRetryByApp(appId!)` instead of bulkRetryAll

    **AppDetail.module.css:**
    Add `.bulkRetryButton` matching the Notifications style.
  </action>
  <verify>
    Run `cd /home/toto/scm-projects/docora && pnpm --filter dashboard build` -- builds without errors.
  </verify>
  <done>
    - "Retry All" button on Notifications page triggers global bulk retry with confirmation
    - "Retry All Failed" button on AppDetail page triggers per-app bulk retry with confirmation
    - Live progress bar with counter and cancel button shown during operation
    - Query cache refreshed on completion/cancellation
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter dashboard build` passes
- `pnpm typecheck` passes
- ConfirmDialog renders with title, message, confirm/cancel buttons
- BulkProgress polls progress endpoint and displays counter
- Notifications page has "Retry All" button when failed notifications exist
- AppDetail page has "Retry All Failed" button when failed count > 0
- Cancel button in BulkProgress calls cancel endpoint
</verification>

<success_criteria>
- Confirmation dialog prevents accidental bulk operations
- Live progress shows "{completed}/{total}" updating every 2s
- Cancel stops remaining retries and shows cancelled state
- After completion, notification list refreshes to reflect new statuses
- Both global and per-app bulk retry work from their respective pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-retry-operations-actions/03-04-SUMMARY.md`
</output>
