---
phase: 05-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server.ts
  - src/routes/admin/auth.ts
  - Dockerfile
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "CSP headers block inline script injection on all responses"
    - "Login endpoint allows max 5 attempts per minute per IP"
    - "Server errors return generic message without stack traces"
    - "Docker image includes both backend dist/ and dashboard/dist/"
  artifacts:
    - path: "src/server.ts"
      provides: "CSP configuration and global error handler"
      contains: "contentSecurityPolicy"
    - path: "src/routes/admin/auth.ts"
      provides: "Login-specific rate limit config"
      contains: "rateLimit"
    - path: "Dockerfile"
      provides: "Multi-stage build with dashboard"
      contains: "dashboard"
    - path: ".dockerignore"
      provides: "Allows dashboard sources in build context"
  key_links:
    - from: "src/server.ts"
      to: "@fastify/helmet"
      via: "CSP directives object"
      pattern: "contentSecurityPolicy.*directives"
    - from: "src/routes/admin/auth.ts"
      to: "@fastify/rate-limit"
      via: "route config.rateLimit"
      pattern: "config.*rateLimit.*max.*5"
    - from: "Dockerfile"
      to: "dashboard/dist"
      via: "COPY --from=builder"
      pattern: "COPY.*dashboard/dist"
---

<objective>
Harden backend security and Docker build for production deployment.

Purpose: Protect the admin dashboard against XSS (CSP), brute-force login (rate limiting), and information leakage (error handler). Enable deployment by including the dashboard build in the Docker image.

Output: Configured CSP headers, login rate limiting, global error handler, production-ready Dockerfile with dashboard.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-production-hardening/05-RESEARCH.md
@src/server.ts
@src/routes/admin/auth.ts
@Dockerfile
@.dockerignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure CSP headers and global error handler</name>
  <files>src/server.ts</files>
  <action>
Modify `src/server.ts` to:

1. **Replace bare `helmet` registration** with explicit CSP directives:
   ```typescript
   await server.register(helmet, {
     contentSecurityPolicy: {
       directives: {
         defaultSrc: ["'self'"],
         scriptSrc: ["'self'"],
         styleSrc: ["'self'", "'unsafe-inline'"],
         imgSrc: ["'self'", "data:"],
         connectSrc: ["'self'"],
         fontSrc: ["'self'"],
         objectSrc: ["'none'"],
         frameAncestors: ["'none'"],
         baseUri: ["'self'"],
         formAction: ["'self'"],
       },
     },
   });
   ```
   - `'self'` for scripts is sufficient because Vite produces content-hashed .js files (no inline scripts)
   - `'unsafe-inline'` for styles is pragmatic because react-hot-toast may inject inline styles
   - `data:` for images allows inline SVG/data URIs used by Lucide icons
   - `'none'` for objects and frame-ancestors prevents embedding

2. **Add global error handler** after all plugin registrations (before `return server`):
   ```typescript
   server.setErrorHandler(function (error, request, reply) {
     request.log.error(error);

     // Validation errors (from fastify-type-provider-zod)
     if (error.validation) {
       return reply.code(400).send({ error: error.message });
     }

     // Client errors (4xx) - safe to forward message
     if (error.statusCode && error.statusCode >= 400 && error.statusCode < 500) {
       return reply.code(error.statusCode).send({ error: error.message });
     }

     // Server errors (5xx) - hide internals
     return reply.code(500).send({ error: 'Internal Server Error' });
   });
   ```
   - Always log full error for debugging
   - Forward 4xx messages (user-facing errors) since they are intentional
   - Return generic "Internal Server Error" for 5xx to hide stack traces and internal details
  </action>
  <verify>Run `pnpm typecheck` to confirm no type errors in server.ts.</verify>
  <done>Helmet registered with explicit CSP directives. Global error handler returns generic message for 5xx, forwards message for 4xx, handles validation errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add login-specific rate limiting</name>
  <files>src/routes/admin/auth.ts</files>
  <action>
Add a stricter rate limit to the login endpoint in `src/routes/admin/auth.ts`:

In the `fastify.post("/admin/api/login", ...)` route options object, add `rateLimit` to the existing `config` field:
```typescript
config: {
  publicAccess: true,
  rateLimit: {
    max: 5,
    timeWindow: '1 minute',
  },
},
```

This merges with the existing `publicAccess: true` config. The `@fastify/rate-limit` plugin reads `config.rateLimit` per-route and overrides the global limit (100/min) with the stricter 5/min for login only.

Do NOT change the logout or session endpoints -- they already use session auth and the global 100/min limit is sufficient.
  </action>
  <verify>Run `pnpm typecheck` to confirm no type errors in auth.ts.</verify>
  <done>Login endpoint limited to 5 requests per minute per IP, while all other endpoints use the global 100/min limit.</done>
</task>

<task type="auto">
  <name>Task 3: Update Dockerfile and .dockerignore for dashboard build</name>
  <files>Dockerfile, .dockerignore</files>
  <action>
1. **Update `Dockerfile`** to build the dashboard in the builder stage:

Replace the current builder stage with a monorepo-aware build:
```dockerfile
FROM node:22-alpine AS builder

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /app

# Copy workspace config and all package.json files for dependency install
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY dashboard/package.json dashboard/
COPY packages/shared-types/package.json packages/shared-types/

RUN pnpm install --frozen-lockfile

# Copy source files
COPY tsconfig.json ./
COPY src ./src
COPY packages ./packages
COPY dashboard ./dashboard

# Build backend and dashboard
RUN pnpm build && pnpm dashboard:build
```

Update the production stage to copy the dashboard dist:
```dockerfile
FROM node:22-alpine AS production

RUN apk add --no-cache git
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

WORKDIR /app

COPY package.json pnpm-lock.yaml ./

RUN pnpm install --frozen-lockfile --prod --ignore-scripts

# Copy built backend
COPY --from=builder /app/dist ./dist
# Copy built dashboard
COPY --from=builder /app/dashboard/dist ./dashboard/dist

RUN mkdir -p /data/repos && chown -R node:node /data

USER node
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

2. **Update `.dockerignore`** to allow dashboard sources in build context while excluding build artifacts:

The current `.dockerignore` has `node_modules`, `dist`, and `*.md` patterns. These are too broad:
- `node_modules` at root is fine (pnpm install runs in Docker)
- `dist` at root blocks both `dist/` AND `dashboard/dist/` - not a problem since we build inside Docker
- `*.md` at root blocks documentation but not source files

Add explicit entries to ensure dashboard sources are NOT excluded. The critical additions:
- Remove `docs` line (or keep if docs/ folder should be excluded)
- Add `dashboard/node_modules` and `dashboard/dist` to be explicit
- Keep `node_modules` and `dist` at root level

Replace the .dockerignore content with:
```
node_modules
dist
coverage
tests
docs
bruno
deploy
docora_dev_data

.husky
.vscode
.claude
.github
.planning

.gitignore
.release-please-manifest.json
release-please-config.json
.env
.env.*
.git
*.md
!dashboard/**
!packages/**
dashboard/node_modules
dashboard/dist
packages/*/node_modules
```

The `!dashboard/**` and `!packages/**` negation patterns ensure workspace source files are included in the build context even though `*.md` and other top-level patterns would otherwise exclude them. The explicit `dashboard/node_modules` and `dashboard/dist` entries re-exclude build artifacts within those directories.
  </action>
  <verify>Run `docker build --target builder -t docora-test .` to verify the builder stage completes successfully (both backend and dashboard build). Then remove the test image with `docker rmi docora-test`.</verify>
  <done>Dockerfile builds backend and dashboard in builder stage, copies both dist/ and dashboard/dist/ to production image. .dockerignore allows dashboard and packages sources in build context.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. CSP headers present on responses: inspect response headers for `Content-Security-Policy`
3. Login rate limit active: verify config key in auth route options
4. Error handler registered: 5xx errors return generic message, not stack traces
5. Docker build: `docker build --target builder .` completes without errors
</verification>

<success_criteria>
- CSP header includes `script-src 'self'`, `object-src 'none'`, `frame-ancestors 'none'`
- POST /admin/api/login has route-level rateLimit config with max: 5
- server.setErrorHandler registered and returns "Internal Server Error" for 5xx
- Dockerfile COPY commands include dashboard/dist
- .dockerignore does not block dashboard/ or packages/ source files
</success_criteria>

<output>
After completion, create `.planning/phases/05-production-hardening/05-01-SUMMARY.md`
</output>
