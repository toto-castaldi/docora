---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/admin-auth.ts
  - src/routes/admin/auth.ts
  - src/routes/admin/index.ts
  - src/server.ts
autonomous: true
user_setup:
  - service: admin-credentials
    why: "Admin authentication requires credentials"
    env_vars:
      - name: ADMIN_USERNAME
        source: "Choose an admin username (e.g., 'admin')"
      - name: ADMIN_PASSWORD
        source: "Choose a secure admin password"
      - name: ADMIN_SESSION_SECRET
        source: "Generate a random 32+ character string (e.g., openssl rand -base64 32)"

must_haves:
  truths:
    - "Admin can log in with username/password and receive session cookie"
    - "Admin can log out and session is invalidated"
    - "Unauthenticated requests to /admin/api/* return 401 JSON"
    - "Admin auth is isolated from client Bearer token auth"
  artifacts:
    - path: "src/plugins/admin-auth.ts"
      provides: "Session-based admin authentication plugin"
      exports: ["default"]
      min_lines: 50
    - path: "src/routes/admin/auth.ts"
      provides: "Login, logout, session check endpoints"
      contains: "/admin/api/login"
    - path: "src/routes/admin/index.ts"
      provides: "Admin routes aggregator"
      exports: ["adminRoutes"]
  key_links:
    - from: "src/server.ts"
      to: "src/plugins/admin-auth.ts"
      via: "fastify.register"
      pattern: "register.*adminAuthPlugin"
    - from: "src/plugins/admin-auth.ts"
      to: "src/queue/connection.ts"
      via: "Redis session store"
      pattern: "getRedisConnection|createRedisConnection"
    - from: "src/routes/admin/auth.ts"
      to: "bcrypt"
      via: "password comparison"
      pattern: "bcrypt\\.compare"
---

<objective>
Implement admin session authentication plugin and login/logout/session API routes.

Purpose: Provide secure server-side session authentication for admin users, completely isolated from the existing Bearer token client API authentication.
Output: Admin auth plugin with @fastify/session, login/logout/session routes under /admin/api/*.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@src/plugins/auth.ts
@src/server.ts
@src/queue/connection.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install session dependencies</name>
  <files>package.json</files>
  <action>
Install the required Fastify session plugins:

```bash
pnpm add @fastify/session @fastify/cookie connect-redis
```

These packages provide:
- @fastify/cookie: Cookie parsing/setting (required by @fastify/session)
- @fastify/session: Server-side session management
- connect-redis: Redis session store (reuses existing ioredis connection)

Note: @fastify/static will be added in Plan 04 when integrating the frontend.
  </action>
  <verify>Run `pnpm list @fastify/session @fastify/cookie connect-redis` to confirm installation</verify>
  <done>@fastify/session, @fastify/cookie, and connect-redis are in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create admin auth plugin</name>
  <files>src/plugins/admin-auth.ts</files>
  <action>
Create the admin authentication plugin at `src/plugins/admin-auth.ts`:

Key requirements from CONTEXT.md:
- Session duration: 1 hour
- Sliding expiration: Yes (each action resets timer)
- Cookie path: /admin (isolate from client API)
- API calls return JSON 401, browser requests redirect to login
- Skip auth check for /admin/api/login, /admin/login, and static assets

Implementation details:
1. Register @fastify/cookie then @fastify/session (order matters)
2. Use connect-redis with existing Redis connection from queue/connection.ts
3. Create decorator to extend FastifyRequest.session with adminId, adminUsername
4. Add onRequest hook scoped to /admin/* routes
5. Check session.adminId for authentication
6. Use request.headers.accept to differentiate API vs browser requests

Session configuration:
- secret: process.env.ADMIN_SESSION_SECRET (min 32 chars)
- store: RedisStore with existing connection
- cookie.path: "/admin"
- cookie.httpOnly: true
- cookie.secure: process.env.NODE_ENV === "production"
- cookie.sameSite: "strict"
- cookie.maxAge: 60 * 60 * 1000 (1 hour)
- rolling: true (sliding expiration)
- saveUninitialized: false

Handle missing ADMIN_SESSION_SECRET gracefully - log warning but allow server to start (routes will return 503).
  </action>
  <verify>Run `pnpm typecheck` to verify TypeScript compiles without errors</verify>
  <done>
- src/plugins/admin-auth.ts exists and exports default plugin
- Plugin extends FastifyRequest.session with adminId and adminUsername
- Session uses Redis store from existing connection
- Auth hook only applies to /admin/* routes
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin auth routes and register in server</name>
  <files>
    src/routes/admin/auth.ts
    src/routes/admin/index.ts
    src/server.ts
  </files>
  <action>
1. Create `src/routes/admin/auth.ts` with login, logout, and session endpoints:

POST /admin/api/login:
- Parse { username, password } from body using zod validation
- Get ADMIN_USERNAME and ADMIN_PASSWORD from environment
- If credentials not configured, return 503 with setup instructions
- Hash ADMIN_PASSWORD with bcrypt on startup (cache the hash)
- Compare username (constant-time) and bcrypt.compare password
- On failure: return 401 { error: "Invalid credentials" } (generic per CONTEXT.md)
- On success: set session.adminId = "admin", session.adminUsername = username
- Return { success: true }

POST /admin/api/logout:
- Call request.session.destroy()
- Return { success: true }

GET /admin/api/session:
- If session.adminId exists: return { authenticated: true, username: session.adminUsername }
- Else: return 401 { error: "Not authenticated" }

2. Create `src/routes/admin/index.ts` as route aggregator:
- Import and register auth routes
- Export adminRoutes function

3. Update `src/server.ts`:
- Import adminAuthPlugin from ./plugins/admin-auth.js
- Import adminRoutes from ./routes/admin/index.js
- Register adminAuthPlugin AFTER existing authPlugin (order matters - existing auth must not interfere)
- Register adminRoutes after admin auth plugin

IMPORTANT: The admin auth plugin must be registered with a prefix option OR the hook must explicitly filter routes. Since we're using an onRequest hook with path checking, no prefix needed.
  </action>
  <verify>
Run these tests:
1. `pnpm typecheck` - TypeScript compiles
2. `pnpm test` - Existing tests pass
3. Start server with `pnpm dev` (in background), then:
   - `curl -X POST http://localhost:3000/admin/api/login -H "Content-Type: application/json" -d '{"username":"test","password":"test"}'` should return 503 (no credentials) or 401 (wrong credentials if env set)
   - `curl http://localhost:3000/admin/api/session` should return 401
  </verify>
  <done>
- /admin/api/login accepts POST with username/password, returns session cookie on success
- /admin/api/logout destroys session
- /admin/api/session returns auth status
- Admin routes are registered in server.ts
- Existing client API auth (Bearer token) continues to work unchanged
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm test` passes (existing tests unaffected)
3. Start server and verify endpoints respond:
   - POST /admin/api/login returns 503 (no admin configured) or 401 (wrong credentials)
   - GET /admin/api/session returns 401 when not authenticated
   - POST /admin/api/logout returns { success: true }
4. Existing /api/* routes still require Bearer token (unchanged behavior)
</verification>

<success_criteria>
- Admin auth plugin is isolated from client Bearer token auth
- Session uses Redis store (not in-memory)
- Login returns session cookie on success, 401 on failure
- Logout destroys session
- Session check returns auth status
- Missing ADMIN_USERNAME/ADMIN_PASSWORD returns 503 with instructions
- All responses follow types defined in shared-types (will be linked in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
