---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/routes/admin/static.ts
  - src/routes/admin/index.ts
  - src/server.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Dashboard is served from /admin/ by Fastify in production"
    - "SPA routing works (direct navigation to /admin/apps returns index.html)"
    - "Admin session persists across browser refreshes without re-login"
    - "Unauthenticated requests to /admin/* redirect to login"
  artifacts:
    - path: "src/routes/admin/static.ts"
      provides: "Static file serving for dashboard SPA"
      contains: "@fastify/static"
    - path: "package.json"
      provides: "Build script that includes dashboard"
      contains: "dashboard:build"
  key_links:
    - from: "src/routes/admin/static.ts"
      to: "dashboard/dist"
      via: "@fastify/static"
      pattern: "dashboard/dist"
    - from: "src/server.ts"
      to: "src/routes/admin/static.ts"
      via: "route registration"
      pattern: "adminRoutes"
---

<objective>
Integrate dashboard static serving with Fastify backend for production deployment.

Purpose: Enable the React dashboard to be served by the Fastify backend, allowing single-deployment production architecture and proper SPA routing.
Output: @fastify/static configuration serving dashboard/dist at /admin/, with SPA catch-all routing.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
@src/server.ts
@src/routes/admin/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @fastify/static and add build scripts</name>
  <files>package.json</files>
  <action>
1. Install @fastify/static:
```bash
pnpm add @fastify/static
```

2. Update root package.json to add dashboard build scripts. Add these to the "scripts" section:
```json
"dashboard:build": "pnpm --filter dashboard build",
"dashboard:dev": "pnpm --filter dashboard dev",
"build:all": "pnpm build && pnpm dashboard:build"
```

The `build:all` script compiles both backend TypeScript and dashboard React app.
  </action>
  <verify>
- `pnpm list @fastify/static` shows the package installed
- `cat package.json | grep dashboard:build` shows the new script
  </verify>
  <done>
- @fastify/static is in dependencies
- dashboard:build, dashboard:dev, build:all scripts added to root package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Create static file serving route for dashboard</name>
  <files>
    src/routes/admin/static.ts
    src/routes/admin/index.ts
  </files>
  <action>
1. Create `src/routes/admin/static.ts`:

```typescript
import type { FastifyInstance } from "fastify";
import fastifyStatic from "@fastify/static";
import path from "node:path";
import { fileURLToPath } from "node:url";
import fs from "node:fs";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export async function registerAdminStaticRoutes(
  server: FastifyInstance
): Promise<void> {
  const dashboardDistPath = path.join(__dirname, "../../../dashboard/dist");

  // Check if dashboard is built
  if (!fs.existsSync(dashboardDistPath)) {
    server.log.warn(
      `Dashboard not built at ${dashboardDistPath}. Run 'pnpm dashboard:build' first.`
    );
    // Register a fallback route that tells developers to build the dashboard
    server.get("/admin", async (_, reply) => {
      return reply.status(503).send({
        error: "Dashboard not built",
        message:
          "Run 'pnpm dashboard:build' to build the admin dashboard, then restart the server.",
      });
    });
    server.get("/admin/*", async (_, reply) => {
      return reply.status(503).send({
        error: "Dashboard not built",
        message:
          "Run 'pnpm dashboard:build' to build the admin dashboard, then restart the server.",
      });
    });
    return;
  }

  // Serve static files from dashboard/dist
  await server.register(fastifyStatic, {
    root: dashboardDistPath,
    prefix: "/admin/",
    decorateReply: false, // Avoid conflict if already decorated
  });

  // SPA catch-all: serve index.html for all /admin/* routes that:
  // 1. Don't match /admin/api/* (API routes)
  // 2. Don't match existing static files
  server.setNotFoundHandler(async (request, reply) => {
    const path = request.url.split("?")[0];

    // Only handle /admin/* routes (excluding API)
    if (path.startsWith("/admin") && !path.startsWith("/admin/api")) {
      const indexPath = `${dashboardDistPath}/index.html`;
      if (fs.existsSync(indexPath)) {
        return reply.type("text/html").send(fs.readFileSync(indexPath));
      }
    }

    // For all other routes, return standard 404
    return reply.status(404).send({ error: "Not found" });
  });
}
```

2. Update `src/routes/admin/index.ts` to include static routes:

The file should aggregate both auth routes and static routes. Ensure the auth routes are registered first so /admin/api/* routes are defined before the SPA catch-all.

```typescript
import type { FastifyInstance } from "fastify";
import { registerAdminAuthRoutes } from "./auth.js";
import { registerAdminStaticRoutes } from "./static.js";

export async function adminRoutes(server: FastifyInstance): Promise<void> {
  // Auth API routes first
  await registerAdminAuthRoutes(server);

  // Static file serving last (includes SPA catch-all)
  await registerAdminStaticRoutes(server);
}
```

IMPORTANT: The order matters. API routes must be registered before the static file serving to prevent the SPA catch-all from intercepting API requests.
  </action>
  <verify>
1. Build dashboard: `pnpm dashboard:build`
2. Start server: `pnpm dev`
3. Navigate to http://localhost:3000/admin/ - should serve dashboard
4. Navigate to http://localhost:3000/admin/login - should serve index.html (SPA routing)
5. API still works: `curl http://localhost:3000/admin/api/session` returns JSON
  </verify>
  <done>
- src/routes/admin/static.ts serves dashboard/dist at /admin/
- SPA catch-all returns index.html for non-API /admin/* routes
- Graceful handling when dashboard not built (503 with instructions)
- API routes (/admin/api/*) take priority over SPA catch-all
  </done>
</task>

<task type="auto">
  <name>Task 3: Add dashboard dist to .gitignore</name>
  <files>.gitignore</files>
  <action>
Add dashboard build output to .gitignore:

Append to existing .gitignore:
```
# Dashboard build output
dashboard/dist/
```

This ensures the built dashboard is not committed to git (it's generated during CI/CD build).
  </action>
  <verify>`grep "dashboard/dist" .gitignore` shows the entry</verify>
  <done>dashboard/dist/ is in .gitignore</done>
</task>

</tasks>

<verification>
1. `pnpm dashboard:build` succeeds and creates dashboard/dist/
2. `pnpm dev` starts server without errors
3. http://localhost:3000/admin/ serves the dashboard (after build)
4. http://localhost:3000/admin/login serves index.html (SPA routing works)
5. http://localhost:3000/admin/api/session returns JSON 401
6. Existing /api/* routes still work with Bearer token auth
7. `grep "dashboard/dist" .gitignore` shows entry exists
</verification>

<success_criteria>
- Dashboard is served at /admin/ when built
- SPA routing works for all /admin/* paths (except API)
- API routes remain functional
- Graceful 503 when dashboard not built
- dashboard/dist/ is gitignored
- Existing client API (Bearer token) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
