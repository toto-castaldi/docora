# Codebase Structure

**Analysis Date:** 2026-01-26

## Directory Layout

```
docora/
├── src/                          # TypeScript source code
│   ├── index.ts                  # Application entry point (mode selection)
│   ├── server.ts                 # Fastify HTTP server builder
│   ├── worker.ts                 # Worker-only mode entry point
│   ├── version.ts                # Version singleton (auto-updated by CI)
│   │
│   ├── db/                       # Database layer
│   │   ├── index.ts              # Kysely connection pool and helpers
│   │   └── types/                # TypeScript schema definitions
│   │       ├── index.ts          # Database interface aggregator
│   │       ├── apps.ts           # AppsTable interface
│   │       ├── repositories.ts   # Repository tables (repos, app_repos, snapshots, files)
│   │       └── deliveries.ts     # AppDeliveredFilesTable interface
│   │
│   ├── routes/                   # HTTP endpoint handlers
│   │   ├── index.ts              # Route registration aggregator
│   │   ├── health.ts             # GET /health
│   │   ├── version.ts            # GET /version
│   │   ├── apps/
│   │   │   ├── index.ts          # Route registration for /api/apps/*
│   │   │   └── onboard.ts        # POST /api/apps/onboard (register new app)
│   │   └── repositories/
│   │       ├── index.ts          # Route registration for /api/repositories/*
│   │       ├── register.ts       # POST /api/repositories (link app to repo)
│   │       └── unwatch.ts        # DELETE /api/repositories/{id} (unlink)
│   │
│   ├── repositories/             # Data access layer (CRUD via Kysely)
│   │   ├── apps.ts               # App table operations
│   │   ├── repositories.ts       # Repository and app-repository operations
│   │   ├── snapshots.ts          # Snapshot CRUD and file tracking
│   │   └── deliveries.ts         # Per-app delivery tracking
│   │
│   ├── services/                 # Business logic and orchestration
│   │   ├── git.ts                # Clone/pull, get commit SHA
│   │   ├── scanner.ts            # File tree walk, hash computation
│   │   ├── change-detector.ts    # Compare snapshots, detect changes
│   │   ├── notifier.ts           # Send file notifications via HTTP
│   │   ├── chunked-notifier.ts   # Handle large binary files
│   │   └── repository-management.ts # Unwatch logic (cleanup)
│   │
│   ├── workers/                  # Asynchronous job processing (BullMQ)
│   │   ├── snapshot.scheduler.ts # Periodic job discovery and queuing
│   │   └── snapshot.worker.ts    # Job processor (clone → scan → notify → save)
│   │
│   ├── queue/                    # Redis/BullMQ infrastructure
│   │   └── connection.ts         # ioredis connection factory
│   │
│   ├── plugins/                  # Fastify plugins and extensions
│   │   ├── auth.ts               # Bearer token verification hook
│   │   ├── swagger.ts            # OpenAPI schema registration
│   │   └── pipeline.ts           # Plugin pipeline interface for transformations
│   │
│   ├── schemas/                  # Request/response validation (Zod)
│   │   ├── apps.ts               # App onboard request/response schemas
│   │   ├── repositories.ts       # Repository register/response schemas
│   │   └── notifications.ts      # Notification payload schemas
│   │
│   └── utils/                    # Utility functions and adapters
│       ├── token.ts              # App ID/token generation, bcrypt verification
│       ├── crypto.ts             # AES-256-GCM encryption/decryption
│       ├── github.ts             # GitHub URL parsing, Octokit API validation
│       ├── url-validator.ts      # SSRF protection for base_url
│       ├── signature.ts          # HMAC-SHA256 webhook signature generation
│       ├── binary.ts             # Binary file detection via isbinaryfile
│       └── chunking.ts           # File chunking utilities for large files
│
├── tests/                        # Test suite (Vitest)
│   ├── unit/                     # Unit tests
│   ├── integration/              # Integration tests
│   └── fixtures/                 # Test data and mocks
│
├── deploy/                       # Deployment configurations
│   └── liquibase/                # Database migrations (YAML format)
│
├── docs-site/                    # Hugo-based public documentation
│   ├── content/                  # Markdown documentation
│   └── Dockerfile                # Multi-stage build (Hugo → nginx)
│
├── .planning/                    # GSD planning documents
│   └── codebase/                 # Architecture and structure analysis
│
├── dist/                         # Compiled JavaScript output (generated by tsc)
│
├── package.json                  # Dependencies, scripts, metadata
├── tsconfig.json                 # TypeScript compiler options
├── vitest.config.ts              # Test framework configuration
├── Dockerfile                    # Production image (node:22-alpine + git)
├── docker-compose.yml            # Local dev environment
└── CLAUDE.md                     # Project conventions and guidelines
```

## Directory Purposes

**src/:**
- Purpose: All TypeScript source code, compiled to dist/ via `tsc`
- Contains: Routes, services, repositories, workers, utilities
- Key files: `index.ts`, `server.ts`, `worker.ts` are entry points

**src/db/:**
- Purpose: Database connection and type definitions
- Contains: Kysely dialect setup, TypeScript interfaces for all tables
- Key files: `index.ts` (getDatabase, initDatabase, closeDatabase), `types/index.ts` (Database interface)

**src/routes/:**
- Purpose: HTTP request handlers with validation and error handling
- Contains: Endpoint logic for app registration, repository linking, health, version
- Key files: `index.ts` (aggregator), `apps/onboard.ts` (app registration), `repositories/register.ts` (repo registration)

**src/repositories/:**
- Purpose: Isolated database operations using Kysely
- Contains: Type-safe SQL building, transaction management, prepared queries
- Key files: `apps.ts` (app CRUD), `repositories.ts` (repo CRUD, circuit breaker), `snapshots.ts` (snapshot upsert), `deliveries.ts` (per-app tracking)

**src/services/:**
- Purpose: Business logic orchestration and external service integration
- Contains: Git operations, file scanning, change detection, notification sending
- Key files: `scanner.ts` (file tree walk), `change-detector.ts` (hash comparison), `notifier.ts` (HTTP POST), `chunked-notifier.ts` (large file handling)

**src/workers/:**
- Purpose: Asynchronous job processing and scheduling
- Contains: BullMQ worker and scheduler
- Key files: `snapshot.worker.ts` (job processor), `snapshot.scheduler.ts` (periodic discovery)

**src/queue/:**
- Purpose: Redis connection management for BullMQ
- Contains: ioredis factory, connection pooling
- Key files: `connection.ts` (getRedisUrl, getRedisOptions, closeRedisConnection)

**src/plugins/:**
- Purpose: Fastify plugins and middleware extensions
- Contains: Authentication, Swagger docs, plugin pipeline
- Key files: `auth.ts` (Bearer token hook), `swagger.ts` (OpenAPI registration), `pipeline.ts` (transformation interface)

**src/schemas/:**
- Purpose: Zod validation schemas for requests and responses
- Contains: Type definitions, validation rules, error messages
- Key files: `apps.ts` (onboard schema), `repositories.ts` (register schema)

**src/utils/:**
- Purpose: Pure functions and third-party adapters
- Contains: Crypto, token generation, GitHub API calls, validation
- Key files: `crypto.ts` (encryption), `github.ts` (Octokit), `signature.ts` (HMAC), `token.ts` (bcrypt, ID generation)

**tests/:**
- Purpose: Automated test suites
- Contains: Unit and integration tests, test fixtures
- Run with: `pnpm test` (once), `pnpm test:watch` (interactive)

**deploy/:**
- Purpose: Infrastructure-as-code and database migrations
- Contains: Liquibase YAML migrations
- Note: Migrations applied before app startup in Docker

**docs-site/:**
- Purpose: Public documentation site
- Contains: Hugo static site generator config, Markdown content
- Build: `docker build -f docs-site/Dockerfile`

## Key File Locations

**Entry Points:**
- `src/index.ts`: Main application entry, selects run mode (api/worker/all)
- `src/server.ts`: Fastify server builder
- `src/worker.ts`: Worker-only mode entry
- `src/routes/index.ts`: Route registration aggregator

**Configuration:**
- `package.json`: Dependencies, version, scripts, Node engine requirement
- `tsconfig.json`: TypeScript compiler options (strict mode, ES2022 target)
- `vitest.config.ts`: Test runner configuration
- `.env.example`: Template for environment variables
- `CLAUDE.md`: Project conventions, architecture overview, development commands

**Core Logic:**
- `src/workers/snapshot.worker.ts`: Main job processor (130+ lines) - orchestrates clone, scan, detect, notify, save
- `src/services/scanner.ts`: File tree walk with SHA-256 hashing (114 lines)
- `src/services/change-detector.ts`: Change detection algorithm (127 lines)
- `src/repositories/repositories.ts`: Repository CRUD and circuit breaker (530 lines)

**Testing:**
- `tests/unit/`: Unit tests for individual functions
- `tests/integration/`: End-to-end flow tests
- `tests/fixtures/`: Mock data, test factories

**Utilities:**
- `src/utils/crypto.ts`: AES-256 encryption wrapper
- `src/utils/github.ts`: GitHub URL parser, Octokit API calls
- `src/utils/signature.ts`: HMAC-SHA256 generation
- `src/utils/token.ts`: App ID/token generation, bcrypt verification

## Naming Conventions

**Files:**
- Routes: `{resource}.ts` (e.g., `onboard.ts`, `register.ts`)
- Services: `{feature}.ts` (e.g., `git.ts`, `scanner.ts`, `notifier.ts`)
- Repositories: `{table}.ts` (e.g., `apps.ts`, `repositories.ts`, `snapshots.ts`)
- Schemas: `{resource}.ts` (e.g., `apps.ts`, `repositories.ts`)
- Index files: `index.ts` (aggregators for route/route registration)

**Directories:**
- Plural for collections: `routes/`, `services/`, `repositories/`, `utils/`, `workers/`, `plugins/`, `schemas/`, `types/`
- Singular for concepts: `src/` (source), `dist/` (distribution), `db/` (database)

**Functions:**
- camelCase: `getDatabase()`, `scanRepository()`, `detectChanges()`, `sendFileNotification()`
- Verbs for actions: `create`, `find`, `update`, `delete`, `save`, `send`, `detect`
- Async functions: Same convention, return Promises

**Variables:**
- camelCase: `app_id`, `repositoryId`, `scannedFiles`, `commitSha`
- Constants: UPPER_SNAKE_CASE: `MAX_RETRY_ATTEMPTS`, `SCAN_INTERVAL_MS`, `EXCLUDED_DIRS`
- Types/Interfaces: PascalCase: `FileChange`, `ScannedFile`, `SnapshotJobData`

**Types:**
- Table interfaces: `{Table}Table` (e.g., `AppsTable`, `RepositoriesTable`)
- Input/output: `{Action}{Noun}Input`, `{Action}{Noun}Output` (e.g., `CreateRepositoryInput`, `OnboardResponse`)
- Enums: PascalCase values (e.g., `ChangeType = "created" | "updated" | "deleted"`)

## Where to Add New Code

**New Feature (e.g., webhook signing):**
- Primary code: `src/services/` (new file or existing service)
- Database: Add table types to `src/db/types/{resource}.ts`, migration to `deploy/liquibase/`
- Repository: Add CRUD to `src/repositories/{resource}.ts`
- Route: Add handler to `src/routes/{resource}/{action}.ts`
- Schemas: Add Zod validators to `src/schemas/{resource}.ts`
- Tests: Mirror structure in `tests/unit/` or `tests/integration/`

**New Component/Module:**
- Implementation: `src/services/{feature}.ts` (under 150 lines) or `src/{layer}/{feature}/` if multiple files
- Exports: Clear interface in module, re-export from `src/index.ts` if public
- Tests: Collocated in `tests/{unit|integration}/`

**Utilities:**
- Shared helpers: `src/utils/{concern}.ts` (e.g., `crypto.ts`, `signature.ts`)
- Pure functions only, no side effects
- Export as named functions

**Routes:**
- New endpoint: `src/routes/{resource}/{action}.ts`
- Register in `src/routes/{resource}/index.ts` with `export async function {resource}Routes()`
- Schema: Add to `src/schemas/{resource}.ts`
- Public routes: Add `{ config: { publicAccess: true } }` to route definition

**Database:**
- New table: Add TypeScript interface to `src/db/types/{resource}.ts`
- Update: `src/db/types/index.ts` to export and include in Database interface
- Migration: New `.yml` file in `deploy/liquibase/` with Liquibase changeset syntax
- CRUD: New repository file `src/repositories/{resource}.ts`

## Special Directories

**dist/:**
- Purpose: Compiled JavaScript output
- Generated: Yes (by `tsc` during build)
- Committed: No (in .gitignore)
- Contents: Mirror of src/ with .js extensions, source maps, type declarations

**docora_dev_data/:**
- Purpose: Local development data (cloned repos, test artifacts)
- Generated: Yes (by git operations during development)
- Committed: No (in .gitignore)
- Mount point: Corresponds to `REPOS_BASE_PATH=/data/repos` in Docker

**deploy/liquibase/:**
- Purpose: Database schema migrations in Liquibase YAML format
- Generated: No (checked in)
- Committed: Yes (must be tracked)
- Format: `.yml` changesets, numbered sequentially (e.g., `001-init.yml`, `002-add-circuit-breaker.yml`)

**node_modules/:**
- Purpose: Installed dependencies
- Generated: Yes (by `pnpm install`)
- Committed: No (in .gitignore)
- Locked: Yes (pnpm-lock.yaml tracks exact versions)

**docs-site/:**
- Purpose: Hugo static site for public API documentation
- Generated: No (source files checked in)
- Committed: Yes (markdown content, Hugo config)
- Build output: Generated in Docker, served by nginx

**.planning/codebase/:**
- Purpose: GSD codebase analysis documents (ARCHITECTURE.md, STRUCTURE.md, etc.)
- Generated: Yes (by GSD orchestrator)
- Committed: Yes (track analysis snapshots)
- Contents: Human-readable guides for future Claude instances
