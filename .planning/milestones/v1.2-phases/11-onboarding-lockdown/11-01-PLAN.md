---
phase: 11-onboarding-lockdown
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/admin/onboard.ts
  - src/routes/admin/index.ts
  - src/routes/apps/onboard.ts
  - src/routes/apps/index.ts
  - src/routes/index.ts
  - src/plugins/admin-auth.ts
  - src/plugins/swagger.ts
  - tests/routes/admin/onboard.test.ts
autonomous: true
requirements:
  - SEC-01

must_haves:
  truths:
    - "Unauthenticated POST to /admin/api/apps/onboard returns 401 with descriptive message"
    - "Bearer-token-only POST to /admin/api/apps/onboard returns 401 (bearer auth is irrelevant for admin routes)"
    - "Authenticated admin POST to /admin/api/apps/onboard returns 201 with app_id, token, created_at"
    - "POST to /api/apps/onboard returns 404 (route no longer exists)"
    - "Browser request to /admin/api/apps/onboard without session redirects to /admin/login"
  artifacts:
    - path: "src/routes/admin/onboard.ts"
      provides: "Admin-only onboard route with custom 401 message"
      contains: "Admin authentication required"
    - path: "tests/routes/admin/onboard.test.ts"
      provides: "Auth enforcement tests for onboard endpoint"
      min_lines: 30
  key_links:
    - from: "src/routes/admin/index.ts"
      to: "src/routes/admin/onboard.ts"
      via: "server.register(adminOnboardRoute)"
      pattern: "adminOnboardRoute"
    - from: "src/plugins/admin-auth.ts"
      to: "/admin/api/apps/onboard"
      via: "PUBLIC_ADMIN_PATHS includes the path so route plugin handles auth"
      pattern: "/admin/api/apps/onboard"
---

<objective>
Move the app onboarding endpoint from the public API (`/api/apps/onboard`) to the admin route tree (`/admin/api/apps/onboard`) with session-based authentication, closing the open-registration security gap.

Purpose: SEC-01 requires that only authenticated admins can onboard new apps. The current route has `publicAccess: true`, meaning anyone can register apps without credentials.

Output: Admin-gated onboard route, old route deleted, Swagger description updated, integration tests for auth enforcement.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-onboarding-lockdown/11-CONTEXT.md
@.planning/phases/11-onboarding-lockdown/11-RESEARCH.md
@src/routes/apps/onboard.ts
@src/routes/admin/index.ts
@src/routes/admin/dashboard-actions.ts
@src/plugins/admin-auth.ts
@src/plugins/auth.ts
@src/plugins/swagger.ts
@src/schemas/apps.ts
@src/routes/index.ts
@src/routes/apps/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Relocate onboard route to admin tree with session auth</name>
  <files>
    src/routes/admin/onboard.ts
    src/routes/admin/index.ts
    src/routes/apps/onboard.ts
    src/routes/apps/index.ts
    src/routes/index.ts
    src/plugins/admin-auth.ts
    src/plugins/swagger.ts
  </files>
  <action>
1. **Create `src/routes/admin/onboard.ts`** — new admin onboard route:
   - Export async function `adminOnboardRoute(server: FastifyInstance)`.
   - Add an encapsulated `onRequest` hook that checks `request.session?.get("adminId")`. If missing:
     - For API requests (check via `accept` header containing `application/json` OR url containing `/admin/api/`): return `reply.code(401).send({ error: "Admin authentication required. Use the admin dashboard to onboard new apps." })`.
     - For browser requests: return `reply.redirect("/admin/login")`.
   - Register `POST /admin/api/apps/onboard` with the same handler logic as the current `onboard.ts`: validate body via `OnboardRequestSchema`, SSRF check via `isUrlSafe`, call `createApp(body)`, return 201 with `OnboardResponseSchema`.
   - Schema response section: 201 → `OnboardResponseSchema`, 401 → `ErrorResponseSchema` (z.object({ error: z.string() })), 422 → `ErrorResponseSchema`.
   - Import from same paths as current route but adjust relative paths (now under `routes/admin/`).

2. **Update `src/plugins/admin-auth.ts`** — add `/admin/api/apps/onboard` to `PUBLIC_ADMIN_PATHS` array so the generic admin-auth hook skips this path (per research recommendation, the route plugin handles its own auth with the custom 401 message).

3. **Update `src/routes/admin/index.ts`** — import `adminOnboardRoute` from `./onboard.js` and register it via `server.register(adminOnboardRoute)` AFTER `authRoutes` but BEFORE `dashboardApiRoutes`.

4. **Delete `src/routes/apps/onboard.ts`** — remove entirely (not just empty, delete the file).

5. **Delete `src/routes/apps/index.ts`** — it has no remaining routes after onboard is moved.

6. **Update `src/routes/index.ts`** — remove the import of `appsRoutes` from `./apps/index.js` and the `server.register(appsRoutes)` call. The file should only register `healthRoutes`, `versionRoutes`, and `repositoriesRoutes`.

7. **Update `src/plugins/swagger.ts`** — change the `bearerAuth` security scheme `description` from `"Enter your app token from /api/apps/onboard"` to `"Enter the app token received during admin onboarding"`. This removes the stale endpoint reference.

Notes:
- The `isApiRequest` helper logic in the route plugin should match the existing pattern in `admin-auth.ts` (check `accept` header for `application/json` OR url contains `/admin/api/`).
- Do NOT add the route to bearer auth's scope. The `auth.ts` plugin already skips `/admin/*` paths.
- File must stay under 150 lines per CLAUDE.md code file size rule.
  </action>
  <verify>
    <automated>pnpm typecheck && pnpm test</automated>
    <manual>Verify that `src/routes/apps/` directory is empty or deleted, and `src/routes/admin/onboard.ts` exists.</manual>
  </verify>
  <done>
- `src/routes/admin/onboard.ts` exists with session-gated POST handler and custom 401 message
- `src/routes/apps/onboard.ts` and `src/routes/apps/index.ts` deleted
- `src/routes/index.ts` no longer references apps routes
- `admin-auth.ts` PUBLIC_ADMIN_PATHS includes `/admin/api/apps/onboard`
- `swagger.ts` bearerAuth description updated
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration tests for admin onboard auth enforcement</name>
  <files>
    tests/routes/admin/onboard.test.ts
  </files>
  <action>
Create `tests/routes/admin/onboard.test.ts` with the following test cases using `server.inject()`:

**Test setup:**
- Import `buildServer` from the server module.
- Set required env vars: `ADMIN_SESSION_SECRET` (32+ chars), `ADMIN_USERNAME`, `ADMIN_PASSWORD`, `DATABASE_URL` (or mock as needed).
- Build a test Fastify server instance with `await buildServer()`.
- Create a helper function `getAdminSessionCookie(server)` that:
  1. POSTs to `/admin/api/login` with valid admin credentials and `accept: application/json` header.
  2. Extracts and returns the `set-cookie` header value.

**Test cases:**

1. **Unauthenticated API request returns 401 with descriptive message:**
   - `POST /admin/api/apps/onboard` with valid body, `accept: application/json`, no cookie.
   - Assert: `statusCode === 401`.
   - Assert: `response.json().error === "Admin authentication required. Use the admin dashboard to onboard new apps."`.

2. **Browser request without session redirects to /admin/login:**
   - `POST /admin/api/apps/onboard` with valid body, `accept: text/html`, no cookie.
   - Assert: `statusCode === 302` (redirect).
   - Assert: `response.headers.location === "/admin/login"`.

3. **Old endpoint /api/apps/onboard returns 404:**
   - `POST /api/apps/onboard` with valid body.
   - Assert: `statusCode === 404`.

4. **Authenticated admin can onboard successfully** (if DB is available, otherwise mock `createApp`):
   - Get admin session cookie via helper.
   - `POST /admin/api/apps/onboard` with valid body, cookie, `accept: application/json`.
   - Assert: `statusCode === 201`.
   - Assert: response contains `app_id`, `token`, `created_at`.

If setting up full DB for test is too complex, mock the `createApp` repository function and test only the auth layer. Use `vi.mock()` for database dependencies. Follow existing test patterns from `tests/health.test.ts` and `tests/routes/repositories/unwatch.test.ts`.

Close server in `afterAll`.
  </action>
  <verify>
    <automated>pnpm test -- tests/routes/admin/onboard.test.ts</automated>
  </verify>
  <done>
- At least 3 test cases pass: unauthenticated 401, old route 404, browser redirect 302
- Tests use `server.inject()` pattern consistent with existing test suite
- All tests pass in CI (`pnpm test` green)
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes — no TypeScript errors
2. `pnpm test` passes — all existing tests + new onboard auth tests
3. `POST /api/apps/onboard` → 404 (old route gone)
4. `POST /admin/api/apps/onboard` without auth → 401 with descriptive message
5. `POST /admin/api/apps/onboard` with admin session → 201
6. Swagger UI at `/docs` shows endpoint under `/admin/api/apps/onboard`, not `/api/apps/onboard`
7. Swagger bearerAuth description no longer references `/api/apps/onboard`
</verification>

<success_criteria>
- SEC-01 satisfied: only authenticated admins can onboard apps
- Old public endpoint completely removed
- Custom 401 error message delivered for all unauthenticated cases
- Integration tests verify auth enforcement
</success_criteria>

<output>
After completion, create `.planning/phases/11-onboarding-lockdown/11-01-SUMMARY.md`
</output>
