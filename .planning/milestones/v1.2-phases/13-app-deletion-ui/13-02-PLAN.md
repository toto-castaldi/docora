---
phase: 13-app-deletion-ui
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - dashboard/src/hooks/useDeleteApp.ts
  - dashboard/src/pages/Apps.tsx
  - dashboard/src/pages/Apps.module.css
  - dashboard/src/pages/AppDetail.tsx
  - dashboard/src/pages/AppDetail.module.css
autonomous: true
requirements: [DEL-03]

must_haves:
  truths:
    - "Admin can initiate app deletion from the Apps list page via a trash icon per row"
    - "Admin can initiate app deletion from the AppDetail page via a red outlined button"
    - "A confirmation dialog shows app name and counts (repositories, snapshots, deliveries) before deletion"
    - "After successful deletion from AppDetail, admin is navigated to /admin/apps with a success toast"
    - "After successful deletion from Apps list, the row disappears via React Query invalidation with a success toast"
    - "On deletion error, the dialog stays open with an error toast so the admin can retry"
    - "Delete button shows a spinner and both dialog buttons are disabled during the API call"
  artifacts:
    - path: "dashboard/src/hooks/useDeleteApp.ts"
      provides: "Delete mutation hook with dialog state management"
      exports: ["useDeleteApp"]
    - path: "dashboard/src/pages/Apps.tsx"
      provides: "Trash2 icon column in apps table with delete confirmation dialog"
      contains: "Trash2"
    - path: "dashboard/src/pages/AppDetail.tsx"
      provides: "Red outlined Delete App button with delete confirmation dialog"
      contains: "Delete App"
  key_links:
    - from: "dashboard/src/hooks/useDeleteApp.ts"
      to: "dashboard/src/api/admin.ts"
      via: "deleteApp function call in useMutation"
      pattern: "deleteApp"
    - from: "dashboard/src/pages/Apps.tsx"
      to: "dashboard/src/hooks/useDeleteApp.ts"
      via: "useDeleteApp hook"
      pattern: "useDeleteApp"
    - from: "dashboard/src/pages/AppDetail.tsx"
      to: "dashboard/src/hooks/useDeleteApp.ts"
      via: "useDeleteApp hook with onSuccess navigation"
      pattern: "useDeleteApp"
---

<objective>
Wire app deletion UI on both the Apps list page and AppDetail page with confirmation dialogs, mutation hooks, and post-deletion behavior.

Purpose: Give admins the ability to delete apps from the dashboard with full visibility into what will be removed and clear feedback on success or failure.
Output: Delete buttons on both pages, confirmation dialogs with impact counts, success toasts, navigation after deletion, error handling.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-app-deletion-ui/13-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01. Executor should use these directly. -->

From packages/shared-types/src/dashboard.ts (after Plan 01):
```typescript
export interface AppDetail extends AppSummary {
  email: string;
  website: string | null;
  description: string | null;
  snapshot_count: number;      // NEW from Plan 01
  delivery_count: number;      // NEW from Plan 01
  repositories: RepositorySummary[];
}

export interface DeleteAppResult {
  deleted: boolean;
  repositories_unlinked: number;
  orphaned_repositories_cleaned: number;
}
```

From dashboard/src/api/admin.ts (after Plan 01):
```typescript
export async function deleteApp(appId: string): Promise<DeleteAppResult>;
export async function fetchAppDetail(appId: string): Promise<AppDetail>;
```

From dashboard/src/components/ConfirmDialog.tsx (after Plan 01):
```typescript
interface ConfirmDialogProps {
  open: boolean;
  title: string;
  message: React.ReactNode;   // Changed from string to ReactNode
  confirmLabel?: string;
  cancelLabel?: string;
  onConfirm: () => void;
  onCancel: () => void;
  variant?: "danger" | "warning";
  loading?: boolean;           // NEW -- disables buttons, shows spinner
}
```

From dashboard/src/hooks/useAppActions.ts (existing pattern reference):
```typescript
// Uses useMutation + useState for dialog state + toast for feedback
// This is the pattern to follow for useDeleteApp
```

From dashboard/src/pages/Apps.tsx (existing):
```typescript
// Uses DataTable with columns array, each column has { key, label, sortable, render }
// AppSummary has app_id, app_name, repository_count, failed_notification_count
```

From dashboard/src/pages/AppDetail.tsx (existing):
```typescript
// Uses useParams, usePollingQuery, useAppActions, ConfirmDialog
// Header has headerInfo div with title + URL, then refreshInfo div
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDeleteApp hook and wire deletion into Apps list page</name>
  <files>
    dashboard/src/hooks/useDeleteApp.ts
    dashboard/src/pages/Apps.tsx
    dashboard/src/pages/Apps.module.css
  </files>
  <action>
1. Create `dashboard/src/hooks/useDeleteApp.ts`:
   - A custom hook `useDeleteApp` that encapsulates delete mutation state and dialog state.
   - Accepts an optional `onSuccess` callback for page-specific behavior (e.g., navigation).
   - Implementation:
     ```typescript
     import { useState } from "react";
     import { useMutation, useQueryClient } from "@tanstack/react-query";
     import toast from "react-hot-toast";
     import { deleteApp, fetchAppDetail } from "../api/admin";
     import type { AppDetail } from "@docora/shared-types";

     interface DeleteTarget {
       appId: string;
       appName: string;
       repositoryCount: number;
       snapshotCount: number;
       deliveryCount: number;
     }

     interface UseDeleteAppOptions {
       onSuccess?: () => void;
     }

     export function useDeleteApp(options?: UseDeleteAppOptions) {
       const queryClient = useQueryClient();
       const [pendingDelete, setPendingDelete] = useState<DeleteTarget | null>(null);

       const deleteMutation = useMutation({
         mutationFn: (appId: string) => deleteApp(appId),
         onSuccess: () => {
           toast.success(`${pendingDelete?.appName} deleted successfully`);
           queryClient.invalidateQueries({ queryKey: ["apps"] });
           queryClient.invalidateQueries({ queryKey: ["overview"] });
           if (pendingDelete) {
             queryClient.invalidateQueries({ queryKey: ["app", pendingDelete.appId] });
           }
           setPendingDelete(null);
           options?.onSuccess?.();
         },
         onError: (error: Error) => {
           toast.error(error.message || "Failed to delete app");
           // Dialog stays open -- pendingDelete not cleared
         },
       });

       const requestDelete = async (appId: string, appName: string, detail?: AppDetail) => {
         if (detail) {
           // AppDetail page -- counts already available
           setPendingDelete({
             appId,
             appName,
             repositoryCount: detail.repository_count,
             snapshotCount: detail.snapshot_count,
             deliveryCount: detail.delivery_count,
           });
         } else {
           // Apps list page -- fetch detail to get counts
           try {
             const appDetail = await fetchAppDetail(appId);
             setPendingDelete({
               appId,
               appName,
               repositoryCount: appDetail.repository_count,
               snapshotCount: appDetail.snapshot_count,
               deliveryCount: appDetail.delivery_count,
             });
           } catch {
             toast.error("Failed to load app details");
           }
         }
       };

       const confirmDelete = () => {
         if (pendingDelete) {
           deleteMutation.mutate(pendingDelete.appId);
         }
       };

       const cancelDelete = () => {
         if (!deleteMutation.isPending) {
           setPendingDelete(null);
         }
       };

       return {
         pendingDelete,
         isPending: deleteMutation.isPending,
         requestDelete,
         confirmDelete,
         cancelDelete,
       };
     }
     ```

2. In `dashboard/src/pages/Apps.tsx`:
   - Add imports: `Trash2` from `lucide-react`, `useDeleteApp` from hooks, `ConfirmDialog` from components.
   - In the `useAppsColumns` function, add a new column at the END of the columns array (after "created_at"):
     ```typescript
     {
       key: "actions",
       label: "",
       sortable: false,
       render: (app) => (
         <button
           className={styles.deleteButton}
           onClick={(e) => {
             e.stopPropagation();
             onDeleteRequest(app.app_id, app.app_name);
           }}
           title="Delete app"
         >
           <Trash2 size={16} />
         </button>
       ),
     }
     ```
   - To pass the delete handler into `useAppsColumns`, change the function signature to accept a callback:
     `function useAppsColumns(onDeleteRequest: (appId: string, appName: string) => void): Column<AppSummary>[]`
   - In the `Apps` component:
     - Call `const deleteApp = useDeleteApp();`
     - Pass `deleteApp.requestDelete` (without detail, so it fetches) to `useAppsColumns`:
       ```typescript
       const columns = useAppsColumns((appId, appName) => deleteApp.requestDelete(appId, appName));
       ```
     - Add the `ConfirmDialog` at the end of the JSX return (before closing `</div>`):
       ```tsx
       <ConfirmDialog
         open={!!deleteApp.pendingDelete}
         title="Delete App"
         message={
           deleteApp.pendingDelete ? (
             <>
               This will permanently delete <strong>{deleteApp.pendingDelete.appName}</strong> along with{" "}
               {deleteApp.pendingDelete.repositoryCount} repositories,{" "}
               {deleteApp.pendingDelete.snapshotCount} snapshots, and{" "}
               {deleteApp.pendingDelete.deliveryCount} deliveries.
             </>
           ) : ""
         }
         confirmLabel="Delete permanently"
         variant="danger"
         loading={deleteApp.isPending}
         onConfirm={deleteApp.confirmDelete}
         onCancel={deleteApp.cancelDelete}
       />
       ```
     - Also add the ConfirmDialog to the empty-state return case (when apps.length === 0 && !hasFilters) -- actually NO, if there are no apps, there's nothing to delete. Only add it to the main return.

3. In `dashboard/src/pages/Apps.module.css`:
   - Add the delete button styles:
     ```css
     .deleteButton {
       display: inline-flex;
       align-items: center;
       justify-content: center;
       padding: 0.25rem;
       background: transparent;
       border: none;
       border-radius: 0.25rem;
       color: #9ca3af;
       cursor: pointer;
       transition: color 0.15s, background-color 0.15s;
     }

     .deleteButton:hover {
       color: #ef4444;
       background-color: #fef2f2;
     }
     ```
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>useDeleteApp hook created. Apps list page has a Trash2 icon column per row. Clicking it fetches app detail, opens confirmation dialog with counts, and handles delete/cancel/error. Row disappears on success via React Query invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Wire deletion into AppDetail page with red outlined button</name>
  <files>
    dashboard/src/pages/AppDetail.tsx
    dashboard/src/pages/AppDetail.module.css
  </files>
  <action>
1. In `dashboard/src/pages/AppDetail.tsx`:
   - Add imports: `Trash2` from `lucide-react`, `useNavigate` from `react-router`, `useDeleteApp` from hooks.
   - Inside the `AppDetail` component, after `const actions = useAppActions(appId!);`, add:
     ```typescript
     const navigate = useNavigate();
     const deleteAction = useDeleteApp({
       onSuccess: () => navigate("/apps"),
     });
     ```
   - In the header section, add the Delete App button. The current header structure is:
     ```tsx
     <div className={styles.header}>
       <div className={styles.headerInfo}>...</div>
       <div className={styles.refreshInfo}>...</div>
     </div>
     ```
     Add the delete button inside `headerInfo`, right after the `<p className={styles.url}>` element:
     ```tsx
     <button
       className={styles.deleteAppButton}
       onClick={() => deleteAction.requestDelete(app.app_id, app.app_name, app)}
     >
       <Trash2 size={14} />
       Delete App
     </button>
     ```
     Note: passing `app` (the full AppDetail) so the hook uses counts directly without an extra fetch.

   - Add the ConfirmDialog at the end of the JSX return (after the last existing ConfirmDialog, before the closing `</div>`):
     ```tsx
     <ConfirmDialog
       open={!!deleteAction.pendingDelete}
       title="Delete App"
       message={
         deleteAction.pendingDelete ? (
           <>
             This will permanently delete <strong>{deleteAction.pendingDelete.appName}</strong> along with{" "}
             {deleteAction.pendingDelete.repositoryCount} repositories,{" "}
             {deleteAction.pendingDelete.snapshotCount} snapshots, and{" "}
             {deleteAction.pendingDelete.deliveryCount} deliveries.
           </>
         ) : ""
       }
       confirmLabel="Delete permanently"
       variant="danger"
       loading={deleteAction.isPending}
       onConfirm={deleteAction.confirmDelete}
       onCancel={deleteAction.cancelDelete}
     />
     ```

2. In `dashboard/src/pages/AppDetail.module.css`:
   - Add the red outlined button style:
     ```css
     .deleteAppButton {
       display: inline-flex;
       align-items: center;
       gap: 0.375rem;
       padding: 0.375rem 0.75rem;
       background-color: transparent;
       border: 1px solid #ef4444;
       border-radius: 0.375rem;
       color: #ef4444;
       font-size: 0.875rem;
       font-weight: 500;
       cursor: pointer;
       transition: background-color 0.15s, color 0.15s;
       margin-top: 0.5rem;
     }

     .deleteAppButton:hover {
       background-color: #ef4444;
       color: white;
     }
     ```
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>AppDetail page has a red outlined "Delete App" button in the header area. Clicking it opens a confirmation dialog with counts. On success, admin is navigated to /apps with a success toast. On error, dialog stays open with an error toast.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes for the entire monorepo.
2. Apps list page: each row has a trash icon. Clicking it opens a danger confirmation dialog showing app name (bold) and counts.
3. AppDetail page: red outlined "Delete App" button in header opens a danger confirmation dialog.
4. On successful deletion from list: row disappears, success toast appears, user stays on list page.
5. On successful deletion from detail: navigates to /apps, success toast appears.
6. On error: dialog stays open, error toast appears, user can retry or cancel.
7. During API call: spinner on confirm button, both buttons disabled.
</verification>

<success_criteria>
- Trash2 icon button per row in Apps list page
- Red outlined "Delete App" button in AppDetail header
- Confirmation dialog with variant="danger", title "Delete App", message showing bold app name and counts
- Confirm button text "Delete permanently"
- Loading spinner + disabled buttons during deletion
- Success toast + React Query invalidation after deletion
- Navigation to /apps after deletion from AppDetail
- Error toast with dialog staying open on failure
- pnpm typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-app-deletion-ui/13-02-SUMMARY.md`
</output>
