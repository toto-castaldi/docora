---
phase: 08-failure-notifications
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - docs-site/content/_index.md
autonomous: true

must_haves:
  truths:
    - "Documentation describes the sync_failed webhook endpoint apps must implement"
    - "Documentation shows the exact sync_failed payload shape with all fields"
    - "Documentation explains when sync_failed is triggered (circuit breaker opens)"
  artifacts:
    - path: "docs-site/content/_index.md"
      provides: "sync_failed webhook documentation"
      contains: "sync_failed"
  key_links:
    - from: "docs-site/content/_index.md"
      to: "src/services/failure-notifier.ts"
      via: "documents the SyncFailedPayload shape"
      pattern: "sync_failed"
---

<objective>
Document the sync_failed webhook endpoint in the Docora documentation site.

Purpose: Client developers integrating with Docora need to know about the new sync_failed notification type so they can implement the endpoint and handle failure alerts.

Output: Updated docs-site with a new section documenting the sync_failed webhook, its payload shape, when it fires, and how to handle it.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-failure-notifications/08-01-SUMMARY.md
@docs-site/content/_index.md
@src/services/failure-notifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync_failed webhook documentation</name>
  <files>docs-site/content/_index.md</files>
  <action>
Read the full `docs-site/content/_index.md` file first to understand the existing documentation structure and style.

Then read `src/services/failure-notifier.ts` (created in Plan 01) to get the exact `SyncFailedPayload` shape.

Add a new section for the sync_failed endpoint. Follow the EXISTING documentation style and structure (look at how create/update/delete endpoints are documented). The new section should include:

1. **Endpoint section** (matching style of create/update/delete sections):
   - Endpoint: `POST {base_url}/sync_failed`
   - Description: Sent when Docora's circuit breaker opens for a watched repository after consecutive git sync failures. This is a proactive alert — your app does not need to poll for failures.

2. **When it fires:**
   - After N consecutive git failures (default threshold: 5), the circuit breaker opens
   - ALL apps watching the affected repository receive the notification
   - The circuit breaker has a cooldown period (default: 30 minutes) before retrying

3. **Payload example** (JSON code block matching existing payload examples):
   ```json
   {
     "event": "sync_failed",
     "repository": {
       "repository_id": "repo_abc123",
       "github_url": "https://github.com/owner/repo",
       "owner": "owner",
       "name": "repo"
     },
     "error": {
       "type": "git_failure",
       "message": "Authentication failed for 'https://github.com/owner/repo.git'"
     },
     "circuit_breaker": {
       "status": "open",
       "consecutive_failures": 5,
       "threshold": 5,
       "cooldown_until": "2024-01-15T12:30:00.000Z"
     },
     "retry_count": 3,
     "timestamp": "2024-01-15T12:00:00.000Z"
   }
   ```

4. **Payload field descriptions** (table format matching existing docs):
   - `event` — Always "sync_failed"
   - `repository` — The repository that failed to sync
   - `error.type` — Error classification (currently always "git_failure")
   - `error.message` — Detailed error message from the git operation
   - `circuit_breaker.status` — Always "open" (notification only fires on open)
   - `circuit_breaker.consecutive_failures` — Number of consecutive failures that triggered the circuit
   - `circuit_breaker.threshold` — Configured failure threshold (default 5)
   - `circuit_breaker.cooldown_until` — ISO 8601 timestamp when Docora will retry syncing
   - `retry_count` — Number of retries attempted for this app-repository pair
   - `timestamp` — When the notification was generated

5. **Recommended actions:**
   - Check if the GitHub token needs rotation (common cause: expired/revoked token)
   - Verify the repository still exists and is accessible
   - Use the PATCH /api/repositories/:repository_id/token endpoint to update the token
   - After the cooldown period, Docora will automatically retry syncing

6. **Authentication note:** This endpoint uses the same HMAC signature verification as all other Docora webhooks. Reference the existing Authentication section.

Also update the Overview section near the top if it says "three endpoints" — change to "four endpoints" or update the language to mention sync_failed alongside create/update/delete. Look for any mentions of "three" notification types or similar that need updating.

IMPORTANT: Match the existing Hugo markdown formatting. Do NOT change the theme, layout, or CSS. Only add content.
  </action>
  <verify>
1. Read `docs-site/content/_index.md` and verify the sync_failed section exists
2. Verify the payload example matches the SyncFailedPayload type from `src/services/failure-notifier.ts`
3. Verify the overview section mentions sync_failed alongside create/update/delete
4. Run `cd /home/toto/scm-projects/docora/docs-site && hugo --minify 2>&1` (if hugo is available) or just verify the markdown is valid
  </verify>
  <done>
- docs-site/_index.md documents the sync_failed webhook endpoint
- Payload shape matches the actual SyncFailedPayload implementation
- Overview mentions all four notification types (create, update, delete, sync_failed)
- Documentation style matches existing sections
  </done>
</task>

</tasks>

<verification>
1. `docs-site/content/_index.md` contains a sync_failed section with endpoint, payload, and field descriptions
2. The payload example matches `SyncFailedPayload` from `src/services/failure-notifier.ts`
3. Overview/introduction mentions all four webhook types
4. No existing documentation is broken or removed
</verification>

<success_criteria>
- sync_failed webhook is documented with endpoint, payload shape, field descriptions, and recommended actions
- Documentation matches the actual implementation
- Existing documentation for create/update/delete is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-failure-notifications/08-02-SUMMARY.md`
</output>
