---
phase: 07-token-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/repositories.ts
  - src/repositories/repositories.ts
  - src/routes/repositories/update-token.ts
  - src/routes/repositories/index.ts
autonomous: true

must_haves:
  truths:
    - "App can PATCH a repository's GitHub token and all existing delivery history is preserved"
    - "Token update is rejected with a clear error if the new token cannot access the repository on GitHub"
    - "After a successful token update, the repository's error state (retry_count, last_error, circuit breaker) is reset to clean"
    - "Existing notification and snapshot behavior continues to work with the new token"
  artifacts:
    - path: "src/schemas/repositories.ts"
      provides: "UpdateTokenRequestSchema and UpdateTokenResponseSchema Zod schemas"
      contains: "UpdateTokenRequestSchema"
    - path: "src/repositories/repositories.ts"
      provides: "updateGithubToken data access function"
      exports: ["updateGithubToken"]
    - path: "src/routes/repositories/update-token.ts"
      provides: "PATCH /api/repositories/:repository_id/token route handler"
      exports: ["updateTokenRoute"]
    - path: "src/routes/repositories/index.ts"
      provides: "Registration of update-token route"
      contains: "updateTokenRoute"
  key_links:
    - from: "src/routes/repositories/update-token.ts"
      to: "src/utils/github.ts"
      via: "validateRepository call before persisting"
      pattern: "validateRepository\\("
    - from: "src/routes/repositories/update-token.ts"
      to: "src/repositories/repositories.ts"
      via: "updateGithubToken to persist encrypted token and reset error state"
      pattern: "updateGithubToken\\("
    - from: "src/repositories/repositories.ts"
      to: "src/utils/crypto.ts"
      via: "encryptToken for new token before storage"
      pattern: "encryptToken\\("
---

<objective>
Add PATCH endpoint for GitHub token rotation so apps can update their private repository token without re-registering or losing delivery history.

Purpose: Apps currently must unwatch and re-register to change a GitHub token, which destroys delivery history and triggers a full rescan. This endpoint allows in-place token rotation.
Output: Working PATCH /api/repositories/:repository_id/token endpoint with GitHub validation, token encryption, and error state reset.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/schemas/repositories.ts
@src/repositories/repositories.ts
@src/routes/repositories/register.ts
@src/routes/repositories/unwatch.ts
@src/routes/repositories/index.ts
@src/utils/github.ts
@src/utils/crypto.ts
@src/db/types/repositories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token update schema and data access function</name>
  <files>src/schemas/repositories.ts, src/repositories/repositories.ts</files>
  <action>
In `src/schemas/repositories.ts`, add two new Zod schemas:

1. `UpdateTokenRequestSchema` - object with:
   - `github_token`: string, required, regex `/^(ghp_|github_pat_)/`, max 255, openapi description "New GitHub personal access token"
   - Apply `.openapi("UpdateTokenRequest")`

2. `UpdateTokenResponseSchema` - object with:
   - `message`: string, openapi example "Token updated successfully"
   - Apply `.openapi("UpdateTokenResponse")`

Export types: `UpdateTokenRequest`, `UpdateTokenResponse`

In `src/repositories/repositories.ts`, add function `updateGithubToken`:

```typescript
export async function updateGithubToken(
  appId: string,
  repositoryId: string,
  githubToken: string
): Promise<boolean>
```

This function must:
1. Encrypt the new token using `encryptToken()` (already imported)
2. Update `app_repositories` table: set `github_token_encrypted` to encrypted value, set `retry_count` to 0, set `last_error` to null, set `status` to `'pending_snapshot'` (triggers fresh scan with new token)
3. Use `.where("app_id", "=", appId).where("repository_id", "=", repositoryId)` to target the specific app-repo link
4. Use `.returning("id")` or `.executeTakeFirst()` to check if a row was actually updated (return false if no matching row)
5. Reset circuit breaker on the repository: call existing `resetGitFailures(repositoryId)` (already in the file) to clear `consecutive_failures` and `circuit_open_until`
6. Return `true` on success

Note: This does NOT touch deliveries - delivery history is preserved by design.
  </action>
  <verify>Run `pnpm typecheck` to confirm no type errors. Grep for `updateGithubToken` and `UpdateTokenRequestSchema` in the modified files to confirm they exist.</verify>
  <done>UpdateTokenRequestSchema and UpdateTokenResponseSchema exist in schemas. updateGithubToken function encrypts token, resets retry_count/last_error/status, resets circuit breaker, and preserves delivery history.</done>
</task>

<task type="auto">
  <name>Task 2: Create PATCH route and register it</name>
  <files>src/routes/repositories/update-token.ts, src/routes/repositories/index.ts</files>
  <action>
Create `src/routes/repositories/update-token.ts` following the exact pattern from `unwatch.ts` and `register.ts`:

```typescript
import type { FastifyInstance } from "fastify";
```

Import schemas: `RepositoryParamsSchema`, `ErrorResponseSchema`, `UpdateTokenRequestSchema`, `UpdateTokenResponseSchema`, and their types from `../../schemas/repositories.js`.

Import `validateRepository` from `../../utils/github.js`.
Import `updateGithubToken`, `getRepositoryById`, `isAppLinkedToRepository` from `../../repositories/repositories.js`.

Export async function `updateTokenRoute(server: FastifyInstance)`:

Register `server.patch` at `/api/repositories/:repository_id/token`:

Schema:
- `description`: "Update GitHub token for a watched repository"
- `security`: `[{ bearerAuth: [] }]`
- `params`: `RepositoryParamsSchema`
- `body`: `UpdateTokenRequestSchema`
- `response`: 200 UpdateTokenResponseSchema, 401/404/422 ErrorResponseSchema

Handler logic (follow register.ts pattern):
1. Extract `repository_id` from `request.params`, `appId` from `request.appId`
2. If no appId, return 401 `{ error: "Unauthorized" }`
3. Check if app is linked to this repository using `isAppLinkedToRepository(appId, repositoryId)`. If not linked, return 404 `{ error: "Repository not found or not registered for this app" }`
4. Get repository details via `getRepositoryById(repositoryId)`. If not found, return 404 `{ error: "Repository not found" }`
5. Validate the new token against GitHub using `validateRepository(repo.owner, repo.name, body.github_token)`. If `!validation.valid`, return 422 `{ error: validation.error ?? "Token cannot access this repository" }`
6. Call `updateGithubToken(appId, repositoryId, body.github_token)`. If returns false, return 500 `{ error: "Failed to update token" }`
7. Return 200 `{ message: "Token updated successfully" }`

In `src/routes/repositories/index.ts`:
- Import `updateTokenRoute` from `./update-token.js`
- Register it: `await server.register(updateTokenRoute);`
  </action>
  <verify>Run `pnpm typecheck` to confirm no type errors. Run `pnpm build` to confirm successful compilation. Verify the route is registered by checking the index file imports updateTokenRoute.</verify>
  <done>PATCH /api/repositories/:repository_id/token endpoint exists, validates bearer token auth, checks app-repo link, validates new token against GitHub API, persists encrypted token, resets error state, and returns success message. Route is registered in repositories index.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm build` compiles successfully
3. PATCH route is registered in the repositories route index
4. The route validates the token against GitHub before persisting (grep for `validateRepository` in update-token.ts)
5. The data access function resets retry_count, last_error, status, and circuit breaker (grep for `retry_count` and `resetGitFailures` in repositories.ts)
6. No delivery-related operations exist in the update flow (delivery history preserved)
</verification>

<success_criteria>
- PATCH /api/repositories/:repository_id/token endpoint compiles and is registered
- Token is validated against GitHub API before storage (422 on invalid token)
- Token is encrypted with AES-256-GCM before database persistence
- retry_count reset to 0, last_error cleared, status set to pending_snapshot
- Circuit breaker (consecutive_failures, circuit_open_until) reset on repositories table
- Delivery history (app_delivered_files) is NOT touched â€” preserved by design
- Bearer token auth required (same as register/unwatch)
</success_criteria>

<output>
After completion, create `.planning/phases/07-token-management/07-01-SUMMARY.md`
</output>
