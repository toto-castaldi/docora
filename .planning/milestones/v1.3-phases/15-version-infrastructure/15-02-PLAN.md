---
phase: 15-version-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 15-01
files_modified:
  - dashboard/src/components/Sidebar.tsx
  - dashboard/src/components/Sidebar.module.css
  - dashboard/vite.config.ts
autonomous: true
requirements:
  - DASH-09

must_haves:
  truths:
    - "Dashboard sidebar footer displays the current version string"
    - "Version is embedded at dashboard build time via Vite define, not fetched from API"
    - "Version display is muted gray, small font — present but unobtrusive"
    - "Version format shows 'v{version}' (e.g., 'v1.0+dev')"
    - "Dashboard builds successfully with pnpm dashboard:build"
  artifacts:
    - path: "dashboard/src/components/Sidebar.tsx"
      provides: "Sidebar with version display in footer"
      contains: "__APP_VERSION__"
    - path: "dashboard/src/components/Sidebar.module.css"
      provides: "Styling for version text in sidebar footer"
      contains: "versionText"
    - path: "dashboard/vite.config.ts"
      provides: "Vite config with define for __APP_VERSION__"
      contains: "__APP_VERSION__"
  key_links:
    - from: "dashboard/vite.config.ts"
      to: "dashboard/src/components/Sidebar.tsx"
      via: "Vite define injects __APP_VERSION__ global at build time"
      pattern: "define.*__APP_VERSION__"
    - from: "package.json"
      to: "dashboard/vite.config.ts"
      via: "Vite reads version from root package.json"
      pattern: "version"
---

<objective>
Display the current version in the dashboard sidebar footer.

Purpose: Make the running version visible to admin users at a glance. The version is embedded at build time (not fetched from API) so it's always available without extra network requests.

Output: Sidebar footer shows version string (e.g., "v1.0+dev") in muted styling below the user info and logout button.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-version-infrastructure/15-CONTEXT.md
@dashboard/src/components/Sidebar.tsx
@dashboard/src/components/Sidebar.module.css
@dashboard/vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject version at build time via Vite define</name>
  <files>dashboard/vite.config.ts</files>
  <action>
Edit `dashboard/vite.config.ts` to inject the version as a build-time constant.

**Approach:** Read the root `package.json` version field and use Vite's `define` option to replace `__APP_VERSION__` at build time. This way the version is baked into the dashboard bundle.

**Changes to vite.config.ts:**

1. Add `import fs from 'node:fs'` at the top (alongside existing `path` import).

2. Before the `defineConfig` call, read the root package.json version:
   ```typescript
   const rootPkg = JSON.parse(
     fs.readFileSync(path.resolve(__dirname, '..', 'package.json'), 'utf-8')
   );
   const appVersion = rootPkg.version.replace(/\.0$/, '');
   ```
   The `.replace(/\.0$/, '')` strips the trailing `.0` from the semver format (`1.0.0` → `1.0`). The suffix (`+dev` or `+108.a3bc02d`) is part of the version in `src/version.ts` but not in package.json. For the dashboard, we show just the base version from package.json.

   **Actually, better approach:** Read `src/version.ts` directly to get the full version with suffix. Parse the VERSION constant from the generated file:
   ```typescript
   const versionFile = fs.readFileSync(
     path.resolve(__dirname, '..', 'src', 'version.ts'), 'utf-8'
   );
   const versionMatch = versionFile.match(/VERSION\s*=\s*"([^"]+)"/);
   const appVersion = versionMatch ? versionMatch[1] : 'unknown';
   ```
   This gets the full baked version like `1.0+dev` or `1.3+108.a3bc02d`.

3. Add `define` to the config object:
   ```typescript
   define: {
     __APP_VERSION__: JSON.stringify(appVersion),
   },
   ```

4. Also add a TypeScript type declaration for the global. Create or check if `dashboard/src/vite-env.d.ts` already exists. If it does, add `declare const __APP_VERSION__: string;` to it. If not, the declaration can be added there.

The final `vite.config.ts` should look like:
```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "node:path";
import fs from "node:fs";

const versionFile = fs.readFileSync(
  path.resolve(__dirname, "..", "src", "version.ts"),
  "utf-8"
);
const versionMatch = versionFile.match(/VERSION\s*=\s*"([^"]+)"/);
const appVersion = versionMatch ? versionMatch[1] : "unknown";

export default defineConfig({
  plugins: [react()],
  base: "/admin/",
  define: {
    __APP_VERSION__: JSON.stringify(appVersion),
  },
  build: {
    outDir: "dist",
    emptyOutDir: true,
  },
  server: {
    port: 5173,
    proxy: {
      "/admin/api": {
        target: "http://localhost:3000",
        changeOrigin: true,
      },
    },
  },
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "src"),
    },
  },
});
```

Then check `dashboard/src/vite-env.d.ts` — add the global type declaration:
```typescript
declare const __APP_VERSION__: string;
```
Add this line to the existing file (it likely already has `/// <reference types="vite/client" />`).
  </action>
  <verify>Run `pnpm typecheck` from the dashboard directory (`cd dashboard && pnpm exec tsc -b`) to confirm no type errors. Verify that `__APP_VERSION__` is defined in vite.config.ts: `grep "__APP_VERSION__" dashboard/vite.config.ts`.</verify>
  <done>Vite config injects __APP_VERSION__ at build time by reading the version from generated src/version.ts. TypeScript declaration added to vite-env.d.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Display version in Sidebar footer</name>
  <files>dashboard/src/components/Sidebar.tsx, dashboard/src/components/Sidebar.module.css</files>
  <action>
Edit `Sidebar.tsx` and `Sidebar.module.css` to display the version in the sidebar footer.

**Sidebar.tsx changes:**

Add a version display element inside the existing `footer` div, below the logout button:
```tsx
<p className={styles.versionText}>v{__APP_VERSION__}</p>
```

The `__APP_VERSION__` global is replaced by Vite at build time with the version string (e.g., `1.0+dev`). The `v` prefix is added in the template since the version string from extract-version doesn't include it.

Place this as the last element inside `<div className={styles.footer}>`, after the logout button.

**Sidebar.module.css changes:**

Add a `.versionText` class at the end of the file:
```css
.versionText {
  margin-top: 0.75rem;
  font-size: 0.625rem;
  color: #6b7280;
  text-align: center;
  letter-spacing: 0.025em;
}
```

Styling rationale (from CONTEXT.md decisions):
- **Muted gray** (`#6b7280` — gray-500) — dimmer than the user info text (`#9ca3af`) to be even more unobtrusive
- **Small font** (`0.625rem` = 10px) — present but not competing with navigation
- **Centered** — consistent with the user info text above
- **Top margin** — separates it from the logout button
  </action>
  <verify>Run `cd /home/toto/scm-projects/docora/dashboard && pnpm exec tsc -b` to verify TypeScript compiles. Verify the version text is in the Sidebar: `grep "versionText\|__APP_VERSION__" dashboard/src/components/Sidebar.tsx`. Verify CSS class exists: `grep "versionText" dashboard/src/components/Sidebar.module.css`.</verify>
  <done>Sidebar footer displays version string in muted gray, small font. Version is baked at build time via Vite define — no API call needed.</done>
</task>

</tasks>

<verification>
1. `dashboard/vite.config.ts` reads version from `src/version.ts` and defines `__APP_VERSION__`
2. `dashboard/src/vite-env.d.ts` declares `__APP_VERSION__` as string type
3. `Sidebar.tsx` displays `v{__APP_VERSION__}` in the footer section
4. `Sidebar.module.css` has `.versionText` class with muted gray styling
5. `pnpm typecheck` passes (root level)
6. Dashboard TypeScript compiles without errors
</verification>

<success_criteria>
- Dashboard sidebar footer displays the current version string (e.g., "v1.0+dev")
- Version is embedded at build time, not fetched from API
- Styling is muted gray, small font — present but unobtrusive
- Dashboard builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/15-version-infrastructure/15-02-SUMMARY.md`
</output>
