---
phase: 17-onboarding-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/admin/onboard.ts
  - dashboard/src/api/admin.ts
  - dashboard/src/components/Sidebar.tsx
  - dashboard/src/App.tsx
  - dashboard/src/pages/Onboard.tsx
  - dashboard/src/pages/Onboard.module.css
autonomous: true
requirements: [ONBD-01, ONBD-02]

must_haves:
  truths:
    - "Admin can navigate to the onboard page from the dashboard sidebar"
    - "Sidebar shows an 'Onboard App' link with a UserPlus icon"
    - "Onboard form has required fields: app_name, base_url, email, client_auth_key"
    - "Onboard form has optional fields: website, description"
    - "Client-side validation shows errors for empty required fields and invalid formats"
    - "Submitting valid form data calls POST /admin/api/apps/onboard and returns app_id + token"
  artifacts:
    - dashboard/src/pages/Onboard.tsx
    - dashboard/src/pages/Onboard.module.css
  key_links:
    - "Sidebar navItems array → /onboard route → Onboard page component"
    - "Onboard form submit → onboardApp() in admin.ts → POST /admin/api/apps/onboard"
    - "Backend onboard route returns { data: { app_id, token, created_at } } matching dashboard postApi convention"
---

<objective>
Add the onboard page to the dashboard so the admin can register new client apps through a form instead of using curl.

Purpose: Admins need a self-service UI for onboarding new apps. The backend endpoint already exists at POST /admin/api/apps/onboard — this plan wires it to the dashboard with navigation and a validated form.

Output: Working onboard form page accessible from sidebar, submits to backend, receives credentials back.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/routes/admin/onboard.ts
@src/schemas/apps.ts
@dashboard/src/api/admin.ts
@dashboard/src/components/Sidebar.tsx
@dashboard/src/App.tsx
@dashboard/src/pages/Login.tsx
@dashboard/src/pages/Apps.tsx
@dashboard/src/pages/Apps.module.css

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/schemas/apps.ts:
```typescript
export const OnboardRequestSchema = z.object({
  base_url: z.string().max(2048).url().refine(/* https in prod, http/https in dev */),
  app_name: z.string().min(3).max(100),
  email: z.string().email().max(255),
  website: z.string().url().max(2048).optional(),
  description: z.string().max(500).optional(),
  client_auth_key: z.string().min(16).max(500),
});

export const OnboardResponseSchema = z.object({
  app_id: z.string(),
  token: z.string(),
  created_at: z.string().datetime(),
});

export type OnboardRequest = z.infer<typeof OnboardRequestSchema>;
export type OnboardResponse = z.infer<typeof OnboardResponseSchema>;
```

From dashboard/src/api/admin.ts:
```typescript
// postApi<T>(endpoint, body) expects response format: { data: T }
// But the current onboard endpoint returns { app_id, token, created_at } directly
// The backend must be updated to wrap in { data: ... } for consistency
async function postApi<T>(endpoint: string, body: unknown): Promise<T>
```

From dashboard/src/components/Sidebar.tsx:
```typescript
interface NavItem {
  to: string;
  icon: typeof LayoutDashboard;
  label: string;
}

const navItems: NavItem[] = [
  { to: "/", icon: LayoutDashboard, label: "Overview" },
  { to: "/apps", icon: Boxes, label: "Apps" },
  { to: "/notifications", icon: AlertCircle, label: "Notifications" },
  { to: "/queue", icon: Clock, label: "Queue" },
];
```

From dashboard/src/App.tsx:
```typescript
// Routes are nested under <ProtectedRoute> → <Layout>
<Route element={<Layout />}>
  <Route index element={<Dashboard />} />
  <Route path="apps" element={<Apps />} />
  <Route path="apps/:appId" element={<AppDetail />} />
  <Route path="notifications" element={<Notifications />} />
  <Route path="queue" element={<Queue />} />
</Route>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Align backend onboard response with dashboard API convention</name>
  <files>src/routes/admin/onboard.ts</files>
  <action>
  The current onboard endpoint returns `{ app_id, token, created_at }` directly, but the dashboard `postApi` helper expects all responses wrapped in `{ data: ... }`. Update the handler to wrap the result:

  In `src/routes/admin/onboard.ts`, change:
  ```typescript
  return reply.status(201).send(result);
  ```
  to:
  ```typescript
  return reply.status(201).send({ data: result });
  ```

  Also update the Fastify schema `response.201` to wrap `OnboardResponseSchema` in `z.object({ data: OnboardResponseSchema })` so Swagger docs reflect the actual shape.

  Note: The 401 and 422 error responses already use `{ error: string }` which matches the dashboard `ApiErrorResponse` format — no change needed there.
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora && pnpm typecheck</automated>
  </verify>
  <done>Backend onboard endpoint returns { data: { app_id, token, created_at } } matching the dashboard postApi convention</done>
</task>

<task type="auto">
  <name>Task 2: Add onboard API call, sidebar link, route, and form page</name>
  <files>
    dashboard/src/api/admin.ts
    dashboard/src/components/Sidebar.tsx
    dashboard/src/App.tsx
    dashboard/src/pages/Onboard.tsx
    dashboard/src/pages/Onboard.module.css
  </files>
  <action>
  **1. Add onboard API function to `dashboard/src/api/admin.ts`:**

  Define an `OnboardFormData` interface and an `OnboardResult` interface at the top of the file:
  ```typescript
  export interface OnboardFormData {
    app_name: string;
    base_url: string;
    email: string;
    client_auth_key: string;
    website?: string;
    description?: string;
  }

  export interface OnboardResult {
    app_id: string;
    token: string;
    created_at: string;
  }
  ```

  Add the function at the bottom (before the `export { ApiError }` line):
  ```typescript
  export async function onboardApp(data: OnboardFormData): Promise<OnboardResult> {
    return postApi<OnboardResult>("/api/apps/onboard", data);
  }
  ```

  **2. Add sidebar navigation link in `dashboard/src/components/Sidebar.tsx`:**

  Import `UserPlus` from lucide-react (add to the existing import). Add a new entry to the `navItems` array:
  ```typescript
  { to: "/onboard", icon: UserPlus, label: "Onboard App" },
  ```
  Place it after the "Queue" entry, as the last nav item before the footer.

  **3. Add route in `dashboard/src/App.tsx`:**

  Import the Onboard page:
  ```typescript
  import { Onboard } from "./pages/Onboard";
  ```

  Add the route inside the `<Layout>` route group, after the queue route:
  ```typescript
  <Route path="onboard" element={<Onboard />} />
  ```

  **4. Create `dashboard/src/pages/Onboard.tsx`:**

  Create an onboard form page that:
  - Has a title "Onboard New App" with a subtitle explaining the purpose
  - Shows a form with these fields:
    - **App Name** (required, text input, min 3 / max 100 chars)
    - **Webhook URL** (required, url input, label says "Base URL", placeholder "https://example.com/webhooks")
    - **Contact Email** (required, email input)
    - **Client Auth Key** (required, password input with show/hide toggle, min 16 chars, explain this is the secret Docora uses to authenticate webhook calls)
    - **Website** (optional, url input)
    - **Description** (optional, textarea, max 500 chars)
  - Each field has a label and a helper text below it
  - Client-side validation: on submit, check required fields are not empty. Show inline error messages per field. Use native HTML5 validation attributes (required, type, minLength, maxLength).
  - On submit: call `onboardApp(formData)` from admin.ts
  - While submitting: show loading state on the submit button (Loader2 spinner + "Onboarding..." text), disable form
  - On error: show error banner above the form with the error message from the API
  - On success: call an `onSuccess` callback prop passed via state or call a callback that will be handled in plan 17-02 (for now, just log the result to console and reset the form — plan 17-02 will add the success modal)
  - Use `useState` for form state (not a form library — keep it simple)
  - Use CSS modules for styling
  - Follow the visual style of existing pages: white card on gray background, consistent spacing, blue primary button

  **5. Create `dashboard/src/pages/Onboard.module.css`:**

  Style the form page following existing dashboard patterns:
  - `.container` with flex column layout, gap
  - `.header` with title styling matching Apps page
  - `.form` as a white card with padding, border-radius, max-width ~600px
  - `.fieldGroup` for each label+input+helper grouping
  - `.label` bold, dark color
  - `.helperText` small, gray
  - `.input` and `.textarea` with consistent border, padding, border-radius
  - `.inputError` red border for validation errors
  - `.errorMessage` red text below field
  - `.errorBanner` red background banner for API errors
  - `.submitButton` matching the primary blue button style from Login page
  - `.optionalBadge` small gray text "(optional)" next to optional field labels
  </action>
  <verify>
    <automated>cd /home/toto/scm-projects/docora/dashboard && npx tsc --noEmit</automated>
  </verify>
  <done>
  - Sidebar shows "Onboard App" link with UserPlus icon
  - Clicking the link navigates to /admin/onboard
  - Form renders with all 6 fields (4 required, 2 optional)
  - Required fields show validation errors when empty
  - Submit calls the backend API and handles loading/error states
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes (backend)
2. `cd dashboard && npx tsc --noEmit` passes (frontend)
3. Sidebar contains "Onboard App" navigation item
4. Route /admin/onboard renders the Onboard page
5. Form has all 6 fields with proper validation
6. Submit button shows loading state during API call
7. API errors display in error banner
</verification>

<success_criteria>
- Admin can navigate to the onboard page from the sidebar
- The onboard form validates required fields (app_name, base_url, email, client_auth_key)
- The form accepts optional fields (website, description)
- Submitting the form calls POST /admin/api/apps/onboard
- Loading and error states are properly handled
</success_criteria>

<output>
After completion, create `.planning/phases/17-onboarding-ui/17-01-SUMMARY.md`
</output>
